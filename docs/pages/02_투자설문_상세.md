# 투자 설문 페이지 상세 문서

## 1. 개요

### 1.1 페이지 설명
투자 설문 페이지는 사용자의 투자 성향을 분석하기 위한 핵심 페이지입니다. 10개의 서술형 질문을 통해 사용자의 투자 철학, 경험, 위험 선호도 등을 종합적으로 파악하고, AI를 활용하여 맞춤형 투자자 프로필을 생성합니다.

### 1.2 주요 기능
- 10개 서술형 질문 단계별 진행
- 실시간 입력 검증
- AI 기반 답변 분석 및 점수화
- 6가지 투자 성향 카테고리 평가
- 투자자 유형 분류 및 포트폴리오 추천
- 설문 결과 시각화

### 1.3 기술 스택
- **Backend**: Flask, OpenAI/Clova API
- **Frontend**: HTML5, CSS3, JavaScript
- **데이터 처리**: pandas, numpy
- **시각화**: Chart.js
- **상태 관리**: Session Storage

---

## 2. 백엔드 구현

### 2.1 설문 페이지 라우트 (app.py: 라인 1289-1305)
```python
@app.route('/survey')
def survey():
    """투자 성향 설문 페이지"""
    try:
        # 세션 확인 및 생성
        if 'user_id' not in session:
            session['user_id'] = str(uuid.uuid4())
            session.permanent = True  # 세션 유지
            logger.info(f"새 사용자 생성: {session['user_id']}")
        
        # 기존 프로필 확인
        user_id = session['user_id']
        existing_profile = get_user_profile(user_id)
        
        if existing_profile:
            # 이미 설문을 완료한 경우 결과 페이지로 리다이렉트
            logger.info(f"기존 프로필 존재: {user_id}")
            return redirect(url_for('survey_result'))
        
        # 설문 페이지 렌더링
        return render_template('survey.html', 
                             user_id=user_id,
                             questions=get_survey_questions())
    
    except Exception as e:
        logger.error(f"설문 페이지 오류: {e}")
        return render_template('error.html', 
                             error="설문 페이지를 불러올 수 없습니다.")
```

### 2.2 설문 질문 데이터
```python
def get_survey_questions():
    """설문 질문 목록 반환"""
    return [
        {
            'id': 1,
            'question': '당신의 투자 철학을 자유롭게 설명해주세요.',
            'placeholder': '예: 장기 투자를 선호하며, 안정적인 수익을 추구합니다...',
            'min_length': 20,
            'category_weights': {
                'investment_goals': 0.3,
                'time_horizon': 0.3,
                'risk_preference': 0.2,
                'decision_style': 0.2
            }
        },
        {
            'id': 2,
            'question': '과거 투자 경험 중 가장 기억에 남는 순간을 공유해주세요.',
            'placeholder': '예: 첫 주식 투자에서 손실을 봤지만, 이를 통해...',
            'min_length': 20,
            'category_weights': {
                'investment_experience': 0.4,
                'risk_preference': 0.3,
                'decision_style': 0.3
            }
        },
        # ... 나머지 8개 질문
    ]
```

### 2.3 설문 제출 API (app.py: 라인 1306-1453)
```python
@app.route('/submit_survey', methods=['POST'])
def submit_survey():
    """설문 응답 제출 및 분석"""
    try:
        # 라인 1310-1325: 요청 검증
        if 'user_id' not in session:
            session['user_id'] = str(uuid.uuid4())
        
        user_id = session['user_id']
        data = request.json
        
        # 데이터 검증
        if not data or 'answers' not in data:
            return jsonify({
                'success': False, 
                'error': '답변 데이터가 없습니다'
            }), 400
        
        answers = data['answers']
        if len(answers) != 10:
            return jsonify({
                'success': False,
                'error': '모든 질문에 답변해주세요'
            }), 400
        
        # 라인 1330-1380: 답변 분석 및 점수화
        total_scores = {
            'risk_preference': 0,
            'investment_experience': 0,
            'financial_knowledge': 0,
            'investment_goals': 0,
            'time_horizon': 0,
            'decision_style': 0
        }
        
        # 각 답변 분석
        for i, answer in enumerate(answers):
            if len(answer.strip()) < 20:
                return jsonify({
                    'success': False,
                    'error': f'{i+1}번 질문의 답변이 너무 짧습니다'
                }), 400
            
            # AI를 통한 답변 분석
            try:
                analyzed_scores = analyze_survey_answer(i, answer)
                
                # 점수 누적
                for category, score in analyzed_scores.items():
                    if category in total_scores:
                        total_scores[category] += score
                        
            except Exception as e:
                logger.error(f"답변 분석 오류 (질문 {i+1}): {e}")
                # 폴백: 기본 점수 부여
                for category in total_scores:
                    total_scores[category] += 5
        
        # 라인 1385-1420: 평균 점수 계산 및 투자자 유형 결정
        # 10개 질문의 평균 점수
        avg_scores = {k: round(v/10, 2) for k, v in total_scores.items()}
        
        # 투자자 유형 결정
        investor_type = determine_investor_type(avg_scores)
        
        # 위험 수준 계산
        risk_level = calculate_risk_level(avg_scores)
        
        # 추천 자산 배분
        recommended_allocation = get_recommended_allocation(investor_type)
        
        # 라인 1425-1450: 프로필 생성 및 저장
        profile = {
            'user_id': user_id,
            'scores': avg_scores,
            'investor_type': investor_type,
            'risk_level': risk_level,
            'recommended_allocation': recommended_allocation,
            'raw_answers': answers,  # 원본 답변 저장
            'created_at': datetime.now().isoformat(),
            'analysis_version': '1.0'  # 분석 버전 관리
        }
        
        # 데이터베이스 저장
        save_user_profile(profile)
        
        # 세션에 저장 (빠른 접근용)
        session['investor_profile'] = profile
        
        # 성공 응답
        return jsonify({
            'success': True,
            'profile': profile,
            'redirect': url_for('survey_result')
        })
        
    except Exception as e:
        logger.error(f"설문 제출 오류: {e}")
        return jsonify({
            'success': False,
            'error': '설문 처리 중 오류가 발생했습니다'
        }), 500
```

### 2.4 AI 답변 분석 함수
```python
def analyze_survey_answer(question_index: int, answer: str) -> dict:
    """
    AI를 통한 개별 답변 분석
    
    Args:
        question_index: 질문 번호 (0-9)
        answer: 사용자 답변
        
    Returns:
        카테고리별 점수 (0-10)
    """
    try:
        # 프롬프트 템플릿 로드
        with open('src/prompt_survey_score.txt', 'r', encoding='utf-8') as f:
            prompt_template = f.read()
        
        # 질문 정보
        question = get_survey_questions()[question_index]
        
        # 프롬프트 생성
        prompt = prompt_template.format(
            question=question['question'],
            answer=answer,
            categories=', '.join(total_scores.keys())
        )
        
        # LLM 호출
        llm_service = LLMService()
        response = llm_service.chat([
            {"role": "system", "content": "당신은 투자 성향 분석 전문가입니다."},
            {"role": "user", "content": prompt}
        ])
        
        # JSON 파싱
        import json
        scores = json.loads(response)
        
        # 점수 검증 (0-10 범위)
        validated_scores = {}
        for category, score in scores.items():
            validated_scores[category] = max(0, min(10, float(score)))
        
        # 질문별 가중치 적용
        weighted_scores = {}
        weights = question.get('category_weights', {})
        
        for category, score in validated_scores.items():
            weight = weights.get(category, 1.0)
            weighted_scores[category] = score * weight
        
        return weighted_scores
        
    except Exception as e:
        logger.error(f"AI 분석 오류: {e}")
        # 폴백: 기본 점수 반환
        return {cat: 5.0 for cat in total_scores.keys()}
```

### 2.5 투자자 유형 분류 함수
```python
def determine_investor_type(scores: dict) -> str:
    """
    점수 기반 투자자 유형 결정
    
    Args:
        scores: 카테고리별 평균 점수
        
    Returns:
        투자자 유형 문자열
    """
    # 주요 지표
    risk_score = scores.get('risk_preference', 5)
    exp_score = scores.get('investment_experience', 5)
    time_score = scores.get('time_horizon', 5)
    
    # 복합 점수 계산
    aggression_score = (risk_score * 0.5 + exp_score * 0.3 + time_score * 0.2)
    
    # 유형 분류
    if aggression_score < 3:
        return "보수적 투자자"
    elif aggression_score < 4.5:
        return "안정추구형 투자자"
    elif aggression_score < 6:
        return "균형투자자"
    elif aggression_score < 7.5:
        return "성장추구형 투자자"
    else:
        return "공격적 투자자"
```

### 2.6 포트폴리오 추천 함수
```python
def get_recommended_allocation(investor_type: str) -> dict:
    """
    투자자 유형별 자산 배분 추천
    
    Args:
        investor_type: 투자자 유형
        
    Returns:
        자산별 배분 비율 (%)
    """
    allocations = {
        "보수적 투자자": {
            "채권": 60,
            "주식": 20,
            "현금": 15,
            "대체투자": 5
        },
        "안정추구형 투자자": {
            "채권": 45,
            "주식": 35,
            "현금": 10,
            "대체투자": 10
        },
        "균형투자자": {
            "채권": 30,
            "주식": 50,
            "현금": 10,
            "대체투자": 10
        },
        "성장추구형 투자자": {
            "채권": 20,
            "주식": 65,
            "현금": 5,
            "대체투자": 10
        },
        "공격적 투자자": {
            "채권": 10,
            "주식": 80,
            "현금": 5,
            "대체투자": 5
        }
    }
    
    return allocations.get(investor_type, allocations["균형투자자"])
```

---

## 3. 프론트엔드 구현

### 3.1 설문 템플릿 (templates/survey.html)
```html
{% extends "layout.html" %}
{% block title %}투자 성향 분석 - Pixie{% endblock %}

{% block content %}
<div class="survey-wrapper">
    <!-- 진행률 표시 -->
    <div class="survey-progress">
        <div class="progress">
            <div class="progress-bar" role="progressbar" 
                 id="progress-bar" 
                 style="width: 10%"
                 aria-valuenow="10" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                <span class="progress-text">1/10</span>
            </div>
        </div>
    </div>
    
    <!-- 설문 컨테이너 -->
    <div class="survey-container">
        <div class="survey-header">
            <h2>투자 성향 분석</h2>
            <p class="lead">
                10개의 질문을 통해 당신만의 투자 성향을 파악하고,
                맞춤형 투자 전략을 제안해드립니다.
            </p>
        </div>
        
        <!-- 설문 폼 -->
        <form id="survey-form" class="survey-form">
            <!-- 질문 1 -->
            <div class="question-container active" data-question="1">
                <div class="question-header">
                    <span class="question-number">Q1</span>
                    <h3 class="question-title">
                        당신의 투자 철학을 자유롭게 설명해주세요.
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q1" 
                        id="q1"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="투자에 대한 생각, 목표, 가치관 등을 자유롭게 작성해주세요. (최소 20자 이상)"
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q1-count">0</span> / 최소 20자
                    </div>
                    
                    <div class="question-tips">
                        <p class="tip">
                            <i class="fas fa-lightbulb"></i>
                            투자 목적, 기대 수익률, 투자 기간 등을 포함하면 
                            더 정확한 분석이 가능합니다.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 질문 2-10 (반복 구조) -->
            <div class="question-container" data-question="2">
                <div class="question-header">
                    <span class="question-number">Q2</span>
                    <h3 class="question-title">
                        과거 투자 경험 중 가장 기억에 남는 순간을 공유해주세요.
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q2" 
                        id="q2"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="성공이든 실패든, 투자 경험에서 배운 점을 설명해주세요. (최소 20자 이상)"
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q2-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 3 -->
            <div class="question-container" data-question="3">
                <div class="question-header">
                    <span class="question-number">Q3</span>
                    <h3 class="question-title">
                        투자 결정을 내릴 때 가장 중요하게 생각하는 요소는 무엇인가요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q3" 
                        id="q3"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="예: 기업의 재무상태, 성장 가능성, 배당금, 시장 트렌드 등"
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q3-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 4 -->
            <div class="question-container" data-question="4">
                <div class="question-header">
                    <span class="question-number">Q4</span>
                    <h3 class="question-title">
                        시장이 급락할 때 당신의 일반적인 반응은 어떤가요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q4" 
                        id="q4"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="시장 하락 시 취하는 행동과 그 이유를 설명해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q4-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 5 -->
            <div class="question-container" data-question="5">
                <div class="question-header">
                    <span class="question-number">Q5</span>
                    <h3 class="question-title">
                        투자 정보는 주로 어디서 얻으시나요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q5" 
                        id="q5"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="뉴스, 리포트, 커뮤니티, 전문가 조언 등 정보 수집 방법을 설명해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q5-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 6 -->
            <div class="question-container" data-question="6">
                <div class="question-header">
                    <span class="question-number">Q6</span>
                    <h3 class="question-title">
                        리스크와 수익률 중 무엇을 더 중시하시나요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q6" 
                        id="q6"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="위험 관리와 수익 추구 사이의 균형에 대한 생각을 공유해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q6-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 7 -->
            <div class="question-container" data-question="7">
                <div class="question-header">
                    <span class="question-number">Q7</span>
                    <h3 class="question-title">
                        장기 투자와 단기 투자 중 선호하는 것은?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q7" 
                        id="q7"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="투자 기간에 대한 선호도와 그 이유를 설명해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q7-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 8 -->
            <div class="question-container" data-question="8">
                <div class="question-header">
                    <span class="question-number">Q8</span>
                    <h3 class="question-title">
                        포트폴리오 다각화에 대한 당신의 생각은?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q8" 
                        id="q8"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="분산 투자의 중요성과 실제 적용 방법에 대해 설명해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q8-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 9 -->
            <div class="question-container" data-question="9">
                <div class="question-header">
                    <span class="question-number">Q9</span>
                    <h3 class="question-title">
                        투자 실패를 어떻게 받아들이시나요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q9" 
                        id="q9"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="손실 발생 시 대처 방법과 마음가짐을 공유해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q9-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 질문 10 -->
            <div class="question-container" data-question="10">
                <div class="question-header">
                    <span class="question-number">Q10</span>
                    <h3 class="question-title">
                        미래 5년 후 투자 목표는 무엇인가요?
                    </h3>
                </div>
                
                <div class="question-body">
                    <textarea 
                        name="q10" 
                        id="q10"
                        class="form-control question-textarea" 
                        rows="6"
                        minlength="20"
                        placeholder="구체적인 재무 목표와 달성 계획을 설명해주세요."
                        required
                    ></textarea>
                    
                    <div class="character-count">
                        <span id="q10-count">0</span> / 최소 20자
                    </div>
                </div>
            </div>
            
            <!-- 네비게이션 버튼 -->
            <div class="survey-navigation">
                <button type="button" 
                        class="btn btn-secondary btn-prev" 
                        onclick="surveyManager.prevQuestion()"
                        disabled>
                    <i class="fas fa-chevron-left"></i> 이전
                </button>
                
                <button type="button" 
                        class="btn btn-primary btn-next" 
                        onclick="surveyManager.nextQuestion()">
                    다음 <i class="fas fa-chevron-right"></i>
                </button>
                
                <button type="submit" 
                        class="btn btn-success btn-submit" 
                        style="display: none;">
                    <i class="fas fa-check"></i> 제출하기
                </button>
            </div>
        </form>
    </div>
    
    <!-- 로딩 모달 -->
    <div class="modal fade" id="loading-modal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">분석 중...</span>
                    </div>
                    <h5>AI가 답변을 분석하고 있습니다</h5>
                    <p class="text-muted">잠시만 기다려주세요...</p>
                    <div class="progress mt-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/survey.js"></script>
{% endblock %}
```

### 3.2 JavaScript 구현 (static/js/survey.js)
```javascript
// 설문 관리 클래스
class SurveyManager {
    constructor() {
        this.currentQuestion = 1;
        this.totalQuestions = 10;
        this.answers = {};
        this.minLength = 20;
        
        this.init();
    }
    
    init() {
        // 이벤트 리스너 설정
        this.setupEventListeners();
        
        // 초기 상태 설정
        this.updateProgress();
        this.updateButtons();
        
        // 자동 저장 설정
        this.setupAutoSave();
        
        // 키보드 네비게이션
        this.setupKeyboardNavigation();
    }
    
    setupEventListeners() {
        // 텍스트 영역 이벤트
        document.querySelectorAll('.question-textarea').forEach(textarea => {
            // 입력 이벤트
            textarea.addEventListener('input', (e) => {
                this.handleTextInput(e.target);
            });
            
            // 포커스 이벤트
            textarea.addEventListener('focus', (e) => {
                e.target.parentElement.classList.add('focused');
            });
            
            textarea.addEventListener('blur', (e) => {
                e.target.parentElement.classList.remove('focused');
            });
        });
        
        // 폼 제출 이벤트
        document.getElementById('survey-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitSurvey();
        });
    }
    
    // 텍스트 입력 처리
    handleTextInput(textarea) {
        const questionNum = textarea.id.replace('q', '');
        const count = textarea.value.length;
        const countElement = document.getElementById(`${textarea.id}-count`);
        
        // 글자 수 업데이트
        countElement.textContent = count;
        
        // 최소 글자 수 체크
        if (count >= this.minLength) {
            countElement.parentElement.classList.add('valid');
            countElement.parentElement.classList.remove('invalid');
        } else {
            countElement.parentElement.classList.add('invalid');
            countElement.parentElement.classList.remove('valid');
        }
        
        // 답변 저장
        this.answers[questionNum] = textarea.value;
        
        // 자동 저장
        this.autoSave();
    }
    
    // 다음 질문으로 이동
    nextQuestion() {
        if (!this.validateCurrentQuestion()) {
            return;
        }
        
        if (this.currentQuestion < this.totalQuestions) {
            this.showQuestion(this.currentQuestion + 1);
        }
    }
    
    // 이전 질문으로 이동
    prevQuestion() {
        if (this.currentQuestion > 1) {
            this.showQuestion(this.currentQuestion - 1);
        }
    }
    
    // 질문 표시
    showQuestion(questionNum) {
        // 모든 질문 숨기기
        document.querySelectorAll('.question-container').forEach(container => {
            container.classList.remove('active');
            container.style.display = 'none';
        });
        
        // 현재 질문 표시
        const currentContainer = document.querySelector(`[data-question="${questionNum}"]`);
        currentContainer.style.display = 'block';
        
        // 애니메이션
        setTimeout(() => {
            currentContainer.classList.add('active');
        }, 50);
        
        // 포커스 설정
        const textarea = currentContainer.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
        
        // 상태 업데이트
        this.currentQuestion = questionNum;
        this.updateProgress();
        this.updateButtons();
        
        // 스크롤 위치 조정
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    // 현재 질문 검증
    validateCurrentQuestion() {
        const textarea = document.querySelector(
            `[data-question="${this.currentQuestion}"] textarea`
        );
        
        if (!textarea) return true;
        
        const value = textarea.value.trim();
        
        // 빈 값 체크
        if (!value) {
            this.showError('답변을 입력해주세요.');
            textarea.focus();
            return false;
        }
        
        // 최소 길이 체크
        if (value.length < this.minLength) {
            this.showError(`최소 ${this.minLength}자 이상 입력해주세요.`);
            textarea.focus();
            return false;
        }
        
        return true;
    }
    
    // 진행률 업데이트
    updateProgress() {
        const progress = (this.currentQuestion / this.totalQuestions) * 100;
        const progressBar = document.getElementById('progress-bar');
        
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        
        const progressText = progressBar.querySelector('.progress-text');
        progressText.textContent = `${this.currentQuestion}/${this.totalQuestions}`;
    }
    
    // 버튼 상태 업데이트
    updateButtons() {
        const prevBtn = document.querySelector('.btn-prev');
        const nextBtn = document.querySelector('.btn-next');
        const submitBtn = document.querySelector('.btn-submit');
        
        // 이전 버튼
        prevBtn.disabled = (this.currentQuestion === 1);
        
        // 다음/제출 버튼
        if (this.currentQuestion === this.totalQuestions) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        }
    }
    
    // 설문 제출
    async submitSurvey() {
        // 모든 질문 검증
        for (let i = 1; i <= this.totalQuestions; i++) {
            const textarea = document.querySelector(`#q${i}`);
            if (!textarea || textarea.value.trim().length < this.minLength) {
                this.showError(`${i}번 질문에 답변해주세요.`);
                this.showQuestion(i);
                return;
            }
        }
        
        // 로딩 모달 표시
        this.showLoadingModal();
        
        try {
            // 답변 배열 생성
            const answersArray = [];
            for (let i = 1; i <= this.totalQuestions; i++) {
                answersArray.push(document.querySelector(`#q${i}`).value.trim());
            }
            
            // API 호출
            const response = await fetch('/submit_survey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    answers: answersArray
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // 성공 시 결과 페이지로 이동
                window.location.href = data.redirect;
            } else {
                this.hideLoadingModal();
                this.showError(data.error || '설문 제출에 실패했습니다.');
            }
            
        } catch (error) {
            console.error('설문 제출 오류:', error);
            this.hideLoadingModal();
            this.showError('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
        }
    }
    
    // 자동 저장 설정
    setupAutoSave() {
        // 기존 저장된 답변 로드
        const savedAnswers = localStorage.getItem('survey_answers');
        if (savedAnswers) {
            this.answers = JSON.parse(savedAnswers);
            this.restoreAnswers();
        }
        
        // 자동 저장 디바운스
        this.autoSaveTimer = null;
    }
    
    // 자동 저장 실행
    autoSave() {
        clearTimeout(this.autoSaveTimer);
        
        this.autoSaveTimer = setTimeout(() => {
            localStorage.setItem('survey_answers', JSON.stringify(this.answers));
            this.showSaveIndicator();
        }, 1000);
    }
    
    // 저장된 답변 복원
    restoreAnswers() {
        Object.entries(this.answers).forEach(([questionNum, answer]) => {
            const textarea = document.querySelector(`#q${questionNum}`);
            if (textarea) {
                textarea.value = answer;
                this.handleTextInput(textarea);
            }
        });
    }
    
    // 저장 인디케이터 표시
    showSaveIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'save-indicator';
        indicator.innerHTML = '<i class="fas fa-check"></i> 자동 저장됨';
        
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            indicator.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            indicator.classList.remove('show');
            setTimeout(() => indicator.remove(), 300);
        }, 2000);
    }
    
    // 키보드 네비게이션
    setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter: 다음 질문 또는 제출
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                if (this.currentQuestion === this.totalQuestions) {
                    this.submitSurvey();
                } else {
                    this.nextQuestion();
                }
            }
            
            // Alt + 좌/우 화살표: 질문 이동
            if (e.altKey) {
                if (e.key === 'ArrowLeft') {
                    this.prevQuestion();
                } else if (e.key === 'ArrowRight') {
                    this.nextQuestion();
                }
            }
        });
    }
    
    // 로딩 모달 표시
    showLoadingModal() {
        const modal = new bootstrap.Modal(document.getElementById('loading-modal'));
        modal.show();
    }
    
    // 로딩 모달 숨기기
    hideLoadingModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loading-modal'));
        if (modal) {
            modal.hide();
        }
    }
    
    // 에러 메시지 표시
    showError(message) {
        // 토스트 생성
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-danger border-0';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // 토스트 컨테이너에 추가
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // 토스트 표시
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // 자동 제거
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
}

// 전역 인스턴스 생성
const surveyManager = new SurveyManager();

// 페이지 언로드 시 자동 저장
window.addEventListener('beforeunload', () => {
    surveyManager.autoSave();
});
```

### 3.3 CSS 스타일 (static/css/survey.css)
```css
/* 설문 페이지 전용 스타일 */

/* 설문 래퍼 */
.survey-wrapper {
    min-height: 100vh;
    background: #f8f9fa;
    padding: 2rem 0;
}

/* 진행률 바 */
.survey-progress {
    position: sticky;
    top: 0;
    background: white;
    padding: 1rem 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    z-index: 100;
    margin-bottom: 2rem;
}

.progress {
    height: 30px;
    background: #e9ecef;
    border-radius: 15px;
    overflow: hidden;
}

.progress-bar {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

/* 설문 컨테이너 */
.survey-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    padding: 3rem;
}

/* 질문 컨테이너 */
.question-container {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.question-container.active {
    opacity: 1;
    transform: translateY(0);
}

/* 질문 헤더 */
.question-header {
    margin-bottom: 2rem;
}

.question-number {
    display: inline-block;
    background: #667eea;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    text-align: center;
    line-height: 40px;
    font-weight: bold;
    margin-right: 1rem;
}

.question-title {
    display: inline-block;
    font-size: 1.25rem;
    font-weight: 600;
    color: #333;
    margin: 0;
}

/* 질문 바디 */
.question-body {
    position: relative;
}

.question-textarea {
    width: 100%;
    min-height: 150px;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    resize: vertical;
    transition: all 0.3s ease;
}

.question-textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.question-body.focused .question-textarea {
    background: #f8f9fa;
}

/* 글자 수 카운터 */
.character-count {
    margin-top: 0.5rem;
    text-align: right;
    font-size: 0.875rem;
    color: #6c757d;
}

.character-count.valid {
    color: #28a745;
}

.character-count.invalid {
    color: #dc3545;
}

/* 질문 팁 */
.question-tips {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #667eea;
}

.tip {
    margin: 0;
    font-size: 0.875rem;
    color: #6c757d;
}

.tip i {
    color: #ffc107;
    margin-right: 0.5rem;
}

/* 네비게이션 버튼 */
.survey-navigation {
    margin-top: 3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.survey-navigation .btn {
    min-width: 120px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.survey-navigation .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-prev i,
.btn-next i {
    transition: transform 0.3s ease;
}

.btn-prev:hover:not(:disabled) i {
    transform: translateX(-3px);
}

.btn-next:hover i {
    transform: translateX(3px);
}

.btn-submit {
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    border: none;
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

/* 로딩 모달 */
#loading-modal .modal-content {
    border: none;
    border-radius: 10px;
}

#loading-modal .spinner-border {
    width: 3rem;
    height: 3rem;
}

/* 저장 인디케이터 */
.save-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.save-indicator.show {
    opacity: 1;
    transform: translateY(0);
}

/* 반응형 디자인 */
@media (max-width: 768px) {
    .survey-container {
        padding: 2rem 1.5rem;
        margin: 0 1rem;
    }
    
    .question-title {
        font-size: 1.1rem;
        display: block;
        margin-top: 1rem;
    }
    
    .survey-navigation {
        flex-direction: column;
        gap: 1rem;
    }
    
    .survey-navigation .btn {
        width: 100%;
    }
}

/* 애니메이션 */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.question-container.active {
    animation: fadeIn 0.5s ease forwards;
}

/* 키보드 네비게이션 포커스 */
.keyboard-nav .btn:focus,
.keyboard-nav .question-textarea:focus {
    outline: 3px solid #667eea;
    outline-offset: 2px;
}

/* 툴팁 스타일 */
.tooltip {
    font-size: 0.875rem;
}

.tooltip-inner {
    background: #333;
    padding: 0.5rem 1rem;
    border-radius: 6px;
}
```

---

## 4. 설문 결과 페이지

### 4.1 결과 페이지 라우트 (app.py: 라인 1454-2155)
```python
@app.route('/survey/result')
def survey_result():
    """설문 결과 페이지"""
    try:
        # 프로필 확인
        if 'investor_profile' not in session:
            # 세션에 없으면 DB에서 조회
            user_id = session.get('user_id')
            if not user_id:
                return redirect(url_for('survey'))
            
            profile = get_user_profile(user_id)
            if not profile:
                return redirect(url_for('survey'))
            
            session['investor_profile'] = profile
        
        profile = session['investor_profile']
        
        # 추천 포트폴리오 생성
        recommendations = generate_portfolio_recommendations(profile)
        
        # 동종 투자자 통계
        peer_stats = get_peer_statistics(profile['investor_type'])
        
        # 시장 적합도 분석
        market_fitness = analyze_market_fitness(profile)
        
        return render_template('survey_result.html',
                             profile=profile,
                             recommendations=recommendations,
                             peer_stats=peer_stats,
                             market_fitness=market_fitness)
        
    except Exception as e:
        logger.error(f"결과 페이지 오류: {e}")
        return redirect(url_for('survey'))
```

### 4.2 결과 템플릿 (templates/survey_result.html)
```html
{% extends "layout.html" %}
{% block title %}투자 성향 분석 결과 - Pixie{% endblock %}

{% block content %}
<div class="result-wrapper">
    <div class="container">
        <!-- 결과 헤더 -->
        <div class="result-header text-center mb-5">
            <h1 class="display-4 fw-bold mb-3">투자 성향 분석 완료</h1>
            <p class="lead">
                AI가 분석한 당신의 투자 성향과 맞춤형 전략을 확인하세요
            </p>
        </div>
        
        <!-- 투자자 유형 카드 -->
        <div class="investor-type-card mb-5">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="row align-items-center">
                        <div class="col-md-4 text-center">
                            <div class="type-icon mb-3">
                                <i class="fas {{ get_investor_icon(profile.investor_type) }} fa-5x text-primary"></i>
                            </div>
                            <h2 class="h3 fw-bold text-primary">
                                {{ profile.investor_type }}
                            </h2>
                        </div>
                        
                        <div class="col-md-8">
                            <h3 class="h5 mb-3">당신의 투자 성향</h3>
                            <p class="mb-4">
                                {{ get_investor_description(profile.investor_type) }}
                            </p>
                            
                            <div class="type-characteristics">
                                <span class="badge bg-primary me-2">
                                    위험 수준: {{ profile.risk_level }}
                                </span>
                                <span class="badge bg-info me-2">
                                    투자 기간: {{ get_time_horizon_label(profile.scores.time_horizon) }}
                                </span>
                                <span class="badge bg-success">
                                    수익 목표: {{ get_return_target(profile.investor_type) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 상세 점수 분석 -->
        <div class="score-analysis mb-5">
            <h3 class="h4 mb-4">상세 성향 분석</h3>
            <div class="row g-4">
                {% for category, score in profile.scores.items() %}
                <div class="col-md-6">
                    <div class="score-item">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="score-label">
                                {{ get_category_korean_name(category) }}
                            </span>
                            <span class="score-value">{{ score }}/10</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" 
                                 role="progressbar" 
                                 style="width: {{ score * 10 }}%; background: {{ get_score_color(score) }};"
                                 aria-valuenow="{{ score * 10 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">
                            {{ get_category_description(category, score) }}
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 추천 포트폴리오 -->
        <div class="recommended-portfolio mb-5">
            <h3 class="h4 mb-4">추천 포트폴리오</h3>
            <div class="row">
                <div class="col-lg-6">
                    <div class="portfolio-chart">
                        <canvas id="portfolio-chart"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="portfolio-details">
                        <h5 class="mb-3">자산 배분 상세</h5>
                        <div class="allocation-list">
                            {% for asset, percentage in profile.recommended_allocation.items() %}
                            <div class="allocation-item d-flex justify-content-between mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="allocation-color" 
                                         style="background: {{ get_asset_color(asset) }};">
                                    </div>
                                    <span class="fw-medium">{{ asset }}</span>
                                </div>
                                <span class="fw-bold">{{ percentage }}%</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="portfolio-tips mt-4">
                            <h6 class="mb-2">포트폴리오 운용 팁</h6>
                            <ul class="small text-muted">
                                {{ get_portfolio_tips(profile.investor_type) | safe }}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 추천 종목 -->
        <div class="recommended-stocks mb-5">
            <h3 class="h4 mb-4">맞춤형 종목 추천</h3>
            <div class="row g-3">
                {% for stock in recommendations.stocks %}
                <div class="col-md-4">
                    <div class="stock-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                {{ stock.name }}
                                <span class="text-muted small">({{ stock.ticker }})</span>
                            </h5>
                            <p class="card-text small">{{ stock.sector }}</p>
                            
                            <div class="stock-metrics">
                                <div class="metric">
                                    <span class="label">현재가</span>
                                    <span class="value">{{ stock.price | number_format }}원</span>
                                </div>
                                <div class="metric">
                                    <span class="label">PER</span>
                                    <span class="value">{{ stock.per }}</span>
                                </div>
                                <div class="metric">
                                    <span class="label">배당률</span>
                                    <span class="value">{{ stock.dividend_yield }}%</span>
                                </div>
                            </div>
                            
                            <div class="recommendation-reason">
                                <p class="small text-muted mb-0">
                                    <i class="fas fa-lightbulb text-warning"></i>
                                    {{ stock.recommendation_reason }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 동종 투자자 비교 -->
        <div class="peer-comparison mb-5">
            <h3 class="h4 mb-4">동종 투자자와의 비교</h3>
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h4 class="h2 text-primary">{{ peer_stats.percentage }}%</h4>
                                <p class="text-muted mb-0">전체 투자자 중 비율</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h4 class="h2 text-success">{{ peer_stats.avg_return }}%</h4>
                                <p class="text-muted mb-0">평균 연간 수익률</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h4 class="h2 text-info">{{ peer_stats.avg_holding_period }}개월</h4>
                                <p class="text-muted mb-0">평균 보유 기간</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <h4 class="h2 text-warning">{{ peer_stats.popular_sector }}</h4>
                                <p class="text-muted mb-0">선호 섹터</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 시장 적합도 -->
        <div class="market-fitness mb-5">
            <h3 class="h4 mb-4">현재 시장 적합도</h3>
            <div class="fitness-gauge">
                <canvas id="fitness-gauge"></canvas>
            </div>
            <div class="fitness-analysis mt-4">
                <p>{{ market_fitness.analysis }}</p>
                <div class="fitness-recommendations">
                    <h6>시장 상황별 전략</h6>
                    <ul>
                        {% for strategy in market_fitness.strategies %}
                        <li>{{ strategy }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 액션 버튼 -->
        <div class="result-actions text-center">
            <a href="/chatbot" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-comments"></i> AI 상담 시작하기
            </a>
            <a href="/my-investment" class="btn btn-outline-primary btn-lg me-3">
                <i class="fas fa-wallet"></i> 포트폴리오 관리
            </a>
            <button class="btn btn-secondary btn-lg" onclick="downloadReport()">
                <i class="fas fa-download"></i> 결과 리포트 다운로드
            </button>
        </div>
    </div>
</div>

<!-- 리포트 다운로드 모달 -->
<div class="modal fade" id="download-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">투자 성향 분석 리포트</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>PDF 형식의 상세 분석 리포트를 다운로드하시겠습니까?</p>
                <ul>
                    <li>투자 성향 상세 분석</li>
                    <li>맞춤형 포트폴리오 전략</li>
                    <li>종목 추천 및 분석</li>
                    <li>리스크 관리 가이드</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="confirmDownload()">
                    <i class="fas fa-download"></i> 다운로드
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 포트폴리오 차트
const portfolioCtx = document.getElementById('portfolio-chart').getContext('2d');
const portfolioData = {{ profile.recommended_allocation | tojson }};

new Chart(portfolioCtx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(portfolioData),
        datasets: [{
            data: Object.values(portfolioData),
            backgroundColor: [
                '#667eea',
                '#764ba2',
                '#f093fb',
                '#4facfe',
                '#00f2fe'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                    }
                }
            }
        },
        cutout: '70%'
    }
});

// 시장 적합도 게이지
const fitnessCtx = document.getElementById('fitness-gauge').getContext('2d');
const fitnessScore = {{ market_fitness.score }};

// 게이지 차트 구현
// ...

// 리포트 다운로드
function downloadReport() {
    const modal = new bootstrap.Modal(document.getElementById('download-modal'));
    modal.show();
}

function confirmDownload() {
    // PDF 생성 및 다운로드
    window.location.href = '/api/download-report?type=survey-result';
}

// 공유 기능
function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Pixie 투자 성향 분석 결과',
            text: `저는 ${profile.investor_type}입니다! Pixie에서 투자 성향을 분석해보세요.`,
            url: window.location.href
        });
    }
}
</script>
{% endblock %}
```

---

## 5. 테스트 시나리오

### 5.1 단위 테스트
```python
# tests/test_survey.py
import pytest
from flask import session
from app import app, analyze_survey_answer, determine_investor_type

class TestSurvey:
    @pytest.fixture
    def client(self):
        app.config['TESTING'] = True
        with app.test_client() as client:
            yield client
    
    def test_survey_page_access(self, client):
        """설문 페이지 접근 테스트"""
        response = client.get('/survey')
        assert response.status_code == 200
        assert b'투자 성향 분석' in response.data
    
    def test_survey_submission_validation(self, client):
        """설문 제출 검증 테스트"""
        # 빈 답변
        response = client.post('/submit_survey', 
                              json={'answers': []})
        assert response.status_code == 400
        
        # 짧은 답변
        response = client.post('/submit_survey',
                              json={'answers': ['짧은 답변'] * 10})
        assert response.status_code == 400
    
    def test_investor_type_classification(self):
        """투자자 유형 분류 테스트"""
        # 보수적 투자자
        conservative_scores = {
            'risk_preference': 2,
            'investment_experience': 2,
            'time_horizon': 8
        }
        assert determine_investor_type(conservative_scores) == "보수적 투자자"
        
        # 공격적 투자자
        aggressive_scores = {
            'risk_preference': 9,
            'investment_experience': 8,
            'time_horizon': 7
        }
        assert determine_investor_type(aggressive_scores) == "공격적 투자자"
```

### 5.2 통합 테스트
```python
# tests/test_survey_integration.py
class TestSurveyIntegration:
    def test_complete_survey_flow(self, client):
        """전체 설문 플로우 테스트"""
        # 1. 설문 페이지 접근
        response = client.get('/survey')
        assert response.status_code == 200
        
        # 2. 설문 응답 제출
        answers = [
            "장기적인 관점에서 안정적인 수익을 추구합니다. 원금 보전이 중요합니다.",
            "첫 투자에서 손실을 봤지만, 이를 통해 리스크 관리의 중요성을 배웠습니다.",
            "기업의 재무 안정성과 배당 수익률을 가장 중요하게 봅니다.",
            "시장 하락 시에는 추가 매수 기회로 활용하되 신중하게 접근합니다.",
            "주로 애널리스트 리포트와 재무제표를 참고합니다.",
            "리스크 관리가 더 중요합니다. 안정적인 수익을 추구합니다.",
            "장기 투자를 선호합니다. 최소 3-5년은 보유할 계획입니다.",
            "포트폴리오 다각화는 필수입니다. 섹터와 자산을 분산합니다.",
            "실패는 학습의 기회입니다. 원인을 분석하고 전략을 수정합니다.",
            "은퇴 자금 마련이 목표입니다. 안정적인 연 5-7% 수익률을 목표로 합니다."
        ]
        
        with client.session_transaction() as sess:
            sess['user_id'] = 'test-user-123'
        
        response = client.post('/submit_survey',
                              json={'answers': answers})
        
        assert response.status_code == 200
        data = response.get_json()
        assert data['success'] is True
        assert 'profile' in data
        assert data['profile']['investor_type'] in [
            "보수적 투자자", "안정추구형 투자자", 
            "균형투자자", "성장추구형 투자자", "공격적 투자자"
        ]
        
        # 3. 결과 페이지 접근
        response = client.get('/survey/result')
        assert response.status_code == 200
```

---

## 6. 성능 최적화

### 6.1 AI 응답 캐싱
```python
from functools import lru_cache
import hashlib

@lru_cache(maxsize=1000)
def cached_analyze_answer(question_hash: str, answer_hash: str) -> dict:
    """캐시된 답변 분석"""
    # 실제 분석 로직
    return analyze_survey_answer_internal(question_hash, answer_hash)

def analyze_survey_answer(question_index: int, answer: str) -> dict:
    """캐싱이 적용된 답변 분석"""
    # 해시 생성
    question_hash = hashlib.md5(
        str(question_index).encode()
    ).hexdigest()
    
    answer_hash = hashlib.md5(
        answer.encode()
    ).hexdigest()
    
    return cached_analyze_answer(question_hash, answer_hash)
```

### 6.2 프론트엔드 최적화
```javascript
// 디바운싱된 자동 저장
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const debouncedAutoSave = debounce(() => {
    surveyManager.autoSave();
}, 1000);

// 텍스트 입력 최적화
document.querySelectorAll('.question-textarea').forEach(textarea => {
    textarea.addEventListener('input', debouncedAutoSave);
});
```

---

## 7. 접근성 및 사용성

### 7.1 키보드 접근성
```javascript
// 키보드 단축키 가이드
class KeyboardShortcuts {
    static showGuide() {
        const guide = `
            <div class="keyboard-guide">
                <h5>키보드 단축키</h5>
                <ul>
                    <li><kbd>Ctrl</kbd> + <kbd>Enter</kbd>: 다음 질문</li>
                    <li><kbd>Alt</kbd> + <kbd>←</kbd>: 이전 질문</li>
                    <li><kbd>Alt</kbd> + <kbd>→</kbd>: 다음 질문</li>
                    <li><kbd>Ctrl</kbd> + <kbd>S</kbd>: 저장</li>
                </ul>
            </div>
        `;
        // 가이드 표시 로직
    }
}
```

### 7.2 모바일 최적화
```css
/* 모바일 전용 스타일 */
@media (max-width: 576px) {
    .survey-container {
        padding: 1.5rem 1rem;
        margin: 0 0.5rem;
    }
    
    .question-textarea {
        font-size: 16px; /* iOS 줌 방지 */
        min-height: 120px;
    }
    
    .survey-navigation {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
}
```

---

## 8. 트러블슈팅

### 8.1 일반적인 문제
1. **설문 저장 실패**
   - 로컬 스토리지 용량 확인
   - 세션 타임아웃 처리
   - 네트워크 연결 확인

2. **AI 분석 오류**
   - API 키 유효성 확인
   - 폴백 메커니즘 동작 확인
   - 에러 로깅 확인

3. **결과 페이지 접근 오류**
   - 세션 데이터 확인
   - 프로필 데이터 무결성 확인
   - 리다이렉트 루프 방지

### 8.2 디버깅 도구
```javascript
// 설문 디버거
class SurveyDebugger {
    static enable() {
        window.SURVEY_DEBUG = true;
        console.log('Survey debugging enabled');
        
        // 상태 모니터링
        setInterval(() => {
            console.log('Current state:', {
                question: surveyManager.currentQuestion,
                answers: surveyManager.answers,
                validation: surveyManager.validateAllQuestions()
            });
        }, 5000);
    }
    
    static exportData() {
        const data = {
            answers: surveyManager.answers,
            timestamp: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], 
                            {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'survey_data.json';
        a.click();
    }
}
```