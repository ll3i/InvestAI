# Pixie AI 챗봇 (Chatbot)

## 개요
Pixie AI 챗봇은 멀티 에이전트 시스템을 활용한 지능형 투자 상담 서비스입니다. 4단계 AI 체인(AI-A → AI-A2 → AI-B → Final)을 통해 사용자에게 정교하고 개인화된 투자 조언을 제공합니다.

## 페이지 구조

### 1. 채팅 인터페이스 (`/chatbot`)
```
헤더: "Pixie AI 투자 상담"
서브헤더: "AI와 대화하며 맞춤형 투자 조언을 받아보세요"
메인 영역:
- 채팅 창 (대화 내역)
- 입력 필드
- 전송 버튼
- AI 상태 표시기
사이드바:
- 대화 히스토리
- 자주 묻는 질문
- 현재 분석 중인 데이터
```

## 멀티 에이전트 시스템 구조

### AI 에이전트 체인
```python
# src/investment_advisor.py
class InvestmentAdvisor:
    def chat(self, user_message, session_id):
        """
        4단계 AI 체인 실행
        각 단계는 순차적으로 실행되며, 
        이전 단계의 결과를 다음 단계에서 활용
        """
        
        # 1단계: AI-A (초기 분석)
        ai_a_response = self.process_ai_a(user_message)
        
        # 2단계: AI-A2 (쿼리 정제)
        ai_a2_response = self.process_ai_a2(ai_a_response)
        
        # 3단계: AI-B (데이터 분석)
        ai_b_response = self.process_ai_b(ai_a2_response)
        
        # 4단계: Final (종합 응답)
        final_response = self.generate_final_response(
            ai_a_response, ai_a2_response, ai_b_response
        )
        
        return final_response
```

### 1단계: AI-A (초기 분석 에이전트)
**역할**: 사용자 의도 파악 및 초기 투자 분석

**프롬프트 구조**:
```
당신은 20년 경력의 투자 전문가입니다.
사용자의 질문을 분석하고 초기 투자 조언을 제공하세요.

[사용자 프로필]
- 투자 성향: {user_profile.risk_type}
- 투자 경험: {user_profile.experience}
- 목표 수익률: {user_profile.target_return}

[질문]
{user_message}

다음 형식으로 답변하세요:
1. 질문 이해
2. 초기 분석
3. 필요한 추가 정보
```

**응답 예시**:
```
질문 이해: 삼성전자 투자 타이밍에 대한 조언 요청

초기 분석: 
- 현재 삼성전자는 반도체 시장 회복 기대감으로 상승 추세
- PER 15.2로 업계 평균 대비 저평가 상태
- 최근 실적 개선 및 배당 확대 긍정적

필요한 추가 정보:
- 최근 3개월 주가 추이
- 외국인/기관 매매 동향
- 반도체 업황 전망
```

### 2단계: AI-A2 (쿼리 정제 에이전트)
**역할**: 데이터 요구사항 명확화 및 구조화

**프롬프트 구조**:
```
AI-A의 분석을 바탕으로 필요한 데이터를 구조화하세요.

[AI-A 분석]
{ai_a_response}

다음 형식의 데이터 쿼리를 생성하세요:
{
    "price_data": ["종목명", "기간"],
    "financial_data": ["재무지표"],
    "market_data": ["시장지표"],
    "news_sentiment": ["키워드"]
}
```

**응답 예시**:
```json
{
    "price_data": {
        "ticker": "005930",
        "period": "3M",
        "indicators": ["close", "volume", "volatility"]
    },
    "financial_data": {
        "metrics": ["PER", "PBR", "ROE", "EPS"],
        "period": "recent_quarter"
    },
    "market_data": {
        "investor_type": ["foreign", "institutional"],
        "period": "1M"
    },
    "news_sentiment": {
        "keywords": ["삼성전자", "반도체", "실적"],
        "period": "1W"
    }
}
```

### 3단계: AI-B (데이터 분석 에이전트)
**역할**: 실시간 데이터 분석 및 인사이트 도출

**처리 과정**:
```python
def process_ai_b(self, data_query):
    """실시간 데이터 수집 및 분석"""
    
    # 데이터 수집
    price_data = self.fetch_price_data(data_query['price_data'])
    financial_data = self.fetch_financial_data(data_query['financial_data'])
    market_data = self.fetch_market_data(data_query['market_data'])
    news_data = self.analyze_news_sentiment(data_query['news_sentiment'])
    
    # 기술적 분석
    technical_analysis = self.calculate_technical_indicators(price_data)
    
    # 종합 분석
    analysis = {
        'current_price': price_data['current'],
        'price_trend': technical_analysis['trend'],
        'valuation': financial_data['valuation_score'],
        'investor_sentiment': market_data['sentiment'],
        'news_impact': news_data['overall_sentiment'],
        'recommendation': self.generate_recommendation(all_data)
    }
    
    return analysis
```

**응답 예시**:
```
[실시간 데이터 분석 결과]

주가 현황:
- 현재가: 72,500원 (전일 대비 +1.2%)
- 3개월 수익률: +8.5%
- 변동성: 18.3% (보통 수준)

기술적 지표:
- RSI: 58 (중립)
- MACD: 상승 신호
- 이동평균선: 20일선 상향 돌파

투자자 동향:
- 외국인: 5일 연속 순매수 (누적 1,200억)
- 기관: 3일 연속 순매수 (누적 800억)

뉴스 감성:
- 전체 감성 점수: +0.65 (긍정적)
- 주요 이슈: 반도체 수요 회복, 실적 개선 기대
```

### 4단계: Final (최종 통합 에이전트)
**역할**: 모든 분석 종합 및 실행 가능한 조언 생성

**통합 프로세스**:
```python
def generate_final_response(self, ai_a, ai_a2, ai_b):
    """모든 에이전트 응답 통합"""
    
    # 컨텍스트 구성
    context = {
        'initial_analysis': ai_a,
        'data_requirements': ai_a2,
        'real_time_analysis': ai_b,
        'user_profile': self.get_user_profile()
    }
    
    # 최종 프롬프트
    prompt = f"""
    모든 분석을 종합하여 구체적이고 실행 가능한 투자 조언을 제공하세요.
    
    [종합 분석]
    {context}
    
    다음 내용을 포함하세요:
    1. 핵심 투자 의견
    2. 구체적 행동 방안
    3. 리스크 요인
    4. 시간 프레임
    5. 대안 전략
    """
    
    return self.llm_service.generate(prompt)
```

## 대화 인터페이스 기능

### 1. 실시간 타이핑 표시
```javascript
// 타이핑 애니메이션
function showTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.innerHTML = `
        <span></span>
        <span></span>
        <span></span>
        <span class="agent-label">AI-A 분석 중...</span>
    `;
    chatContainer.appendChild(indicator);
}
```

### 2. 에이전트 식별 표시
각 AI 에이전트의 응답을 시각적으로 구분:
- **AI-A**: 🤖 파란색 배경
- **AI-A2**: 🔍 보라색 배경
- **AI-B**: 📊 초록색 배경
- **Final**: ✨ 금색 배경

### 3. 스트리밍 응답
```python
@app.route('/api/chat', methods=['POST'])
def chat_endpoint():
    def generate():
        # 각 에이전트 응답을 실시간 스트리밍
        for agent, response in advisor.chat_stream(message):
            yield f"data: {json.dumps({
                'agent': agent,
                'content': response,
                'timestamp': datetime.now().isoformat()
            })}\n\n"
    
    return Response(generate(), mimetype='text/event-stream')
```

## 대화 예시

### 예시 1: 종목 추천
**사용자**: "요즘 투자하기 좋은 한국 주식 추천해줘"

**AI 응답**:
```
🤖 AI-A: 현재 시장 상황과 당신의 위험중립형 투자 성향을 고려하여 분석하겠습니다.

🔍 AI-A2: 섹터별 상위 종목 데이터를 조회 중...

📊 AI-B: 
[데이터 분석 결과]
- IT: 삼성전자(+12%), SK하이닉스(+18%)
- 바이오: 셀트리온(+8%), 삼성바이오로직스(+6%)
- 배터리: LG에너지솔루션(+15%), 삼성SDI(+10%)

✨ 최종 추천:
1. 삼성전자 (005930)
   - 추천 이유: 반도체 업황 회복, 저평가 구간
   - 목표가: 80,000원
   - 투자 비중: 30%

2. LG에너지솔루션 (373220)
   - 추천 이유: 전기차 시장 성장, 기술 경쟁력
   - 목표가: 550,000원
   - 투자 비중: 20%

3. KB금융 (105560)
   - 추천 이유: 고금리 수혜, 안정적 배당
   - 목표가: 70,000원
   - 투자 비중: 20%

리스크 관리:
- 분할 매수 전략 추천
- 전체 포트폴리오의 70% 이내 투자
- 3개월마다 리밸런싱
```

### 예시 2: 시장 분석
**사용자**: "최근 코스피가 계속 떨어지는데 왜 그런거야?"

**AI 응답**:
```
🤖 AI-A: 최근 KOSPI 하락 원인을 분석하겠습니다.

🔍 AI-A2: 거시경제 지표와 투자자별 매매 동향 조회 중...

📊 AI-B:
[시장 데이터]
- KOSPI: 2,450 (-3.5% 1주일)
- 외국인: 5일 연속 순매도 (누적 -1.2조)
- 기관: 3일 연속 순매도 (누적 -0.8조)
- 달러/원: 1,340원 (1주일 +2.5%)

✨ 하락 원인 분석:

주요 요인:
1. 미국 금리 인상 우려
   - Fed의 매파적 발언으로 긴축 지속 예상
   - 글로벌 유동성 축소 우려

2. 중국 경기 둔화
   - 중국 제조업 PMI 48.5로 위축
   - 한국 수출 기업 실적 우려

3. 원화 약세
   - 달러 강세로 외국인 이탈
   - 환차손 우려 증가

대응 전략:
- 단기: 현금 비중 확대 (30-40%)
- 중기: 저가 분할 매수 준비
- 관심 구간: KOSPI 2,400-2,420
```

## 고급 기능

### 1. 컨텍스트 유지
```python
class MemoryManager:
    def __init__(self):
        self.conversation_history = []
        self.user_context = {}
    
    def add_message(self, role, content):
        self.conversation_history.append({
            'role': role,
            'content': content,
            'timestamp': datetime.now()
        })
    
    def get_context(self, max_messages=10):
        """최근 대화 컨텍스트 반환"""
        return self.conversation_history[-max_messages:]
```

### 2. 멀티모달 입력
- **이미지 업로드**: 차트, 재무제표 스크린샷 분석
- **파일 첨부**: Excel 포트폴리오 분석
- **음성 입력**: 음성 질문 지원

### 3. 추천 액션 버튼
대화 중 즉시 실행 가능한 액션 제공:
```
[포트폴리오 분석] [뉴스 보기] [차트 확인] [매수 주문]
```

### 4. 대화 내보내기
- **PDF 저장**: 상담 내역 PDF 생성
- **이메일 전송**: 주요 조언 이메일 발송
- **메모 저장**: 중요 내용 북마크

## 성능 최적화

### 1. 응답 시간 단축
```python
# 병렬 처리로 응답 시간 최적화
async def parallel_agent_processing():
    tasks = [
        asyncio.create_task(process_ai_a()),
        asyncio.create_task(fetch_market_data()),
        asyncio.create_task(analyze_news())
    ]
    results = await asyncio.gather(*tasks)
    return combine_results(results)
```

### 2. 캐싱 전략
- **프로필 캐싱**: 사용자 프로필 5분 캐시
- **데이터 캐싱**: 시장 데이터 1분 캐시
- **응답 캐싱**: 자주 묻는 질문 응답 캐시

### 3. 에러 처리
```python
def handle_agent_error(agent_name, error):
    """에이전트 오류 시 graceful degradation"""
    if agent_name == 'AI-B':
        # 데이터 에이전트 실패 시 캐시된 데이터 사용
        return get_cached_data()
    else:
        # 다른 에이전트 실패 시 단순화된 응답
        return get_fallback_response()
```

## 피드백 시스템

### 1. 응답 평가
각 응답에 대한 사용자 피드백:
- 👍 도움됨
- 👎 도움 안됨
- 💡 더 자세히

### 2. 개선 학습
```python
def collect_feedback(session_id, message_id, rating):
    """피드백 수집 및 모델 개선"""
    feedback = {
        'session_id': session_id,
        'message_id': message_id,
        'rating': rating,
        'timestamp': datetime.now()
    }
    
    # 피드백 저장
    save_feedback(feedback)
    
    # 낮은 평가 응답 분석
    if rating < 3:
        analyze_poor_response(message_id)
```

## 보안 및 프라이버시

### 1. 데이터 보호
- **암호화**: 모든 대화 내용 AES-256 암호화
- **익명화**: 개인 정보 자동 마스킹
- **만료**: 30일 후 대화 기록 자동 삭제

### 2. 접근 제어
- **세션 검증**: UUID 기반 세션 관리
- **Rate Limiting**: 분당 10회 요청 제한
- **IP 차단**: 악의적 사용 감지 시 차단

## 향후 개발 계획

1. **음성 대화**: 실시간 음성 상담 지원
2. **화상 상담**: 아바타 기반 화상 상담
3. **다국어 지원**: 영어, 중국어, 일본어
4. **전문가 연결**: 실제 전문가 상담 연계
5. **AR 차트**: 증강현실 차트 분석