# 05_뉴스이슈_상세.md - 뉴스/이슈 페이지 개발 문서

## 목차
1. [페이지 개요](#1-페이지-개요)
2. [백엔드 구현](#2-백엔드-구현)
3. [프론트엔드 구현](#3-프론트엔드-구현)
4. [뉴스 데이터 처리](#4-뉴스-데이터-처리)
5. [API 엔드포인트](#5-api-엔드포인트)
6. [UI/UX 디자인](#6-uiux-디자인)
7. [실시간 업데이트](#7-실시간-업데이트)
8. [감정 분석](#8-감정-분석)
9. [성능 최적화](#9-성능-최적화)
10. [데이터 소스 통합](#10-데이터-소스-통합)

---

## 1. 페이지 개요

### 1.1 목적
실시간 금융 뉴스와 시장 이슈를 제공하며, AI 기반 감정 분석을 통해 시장 심리를 파악할 수 있도록 지원합니다. 사용자의 포트폴리오와 관심 종목에 맞춤화된 뉴스를 우선 제공합니다.

### 1.2 주요 기능
- **실시간 뉴스 수집**: 네이버 금융, RSS 피드 등 다양한 소스
- **AI 감정 분석**: 긍정/부정/중립 분류 및 점수화
- **맞춤형 필터링**: 국내/해외, 카테고리별, 관심 종목별
- **캐러셀 UI**: 주요 뉴스 하이라이트 표시
- **키워드 관리**: 사용자별 관심 키워드 설정

### 1.3 파일 구조
```
web/
├── app.py                      # API 엔드포인트
├── templates/
│   └── news.html              # 뉴스 페이지 UI
└── static/
    └── js/
        └── news.js            # 뉴스 기능 JavaScript
        
src/
├── news_sentiment_analyzer.py  # AI 감정 분석
├── enhanced_news_collector.py  # 뉴스 수집기
└── real_data_manager.py       # 데이터 관리
```

---

## 2. 백엔드 구현

### 2.1 메인 뉴스 라우트 (`app.py:3352-3355`)

```python
@app.route('/news')
def news_page():
    """뉴스/이슈 분석 결과 시각화 페이지"""
    return render_template('news.html')
```

### 2.2 뉴스 API 엔드포인트 (`app.py:3280-3350`)

```python
@app.route('/api/news', methods=['GET'])
def api_news():
    """최신 뉴스/이슈 요약 반환 (CSV 파일 기반, 국내 뉴스 우선)"""
    query = request.args.get('query', '')
    session_id = session.get('user_id')
    if not session_id:
        session_id = f"user_{str(uuid.uuid4())[:8]}"
        session['user_id'] = session_id
    
    try:
        # CSV 파일에서 뉴스 데이터 로드
        news_data = real_data_manager.load_news_data()
        
        if news_data:
            # 쿼리 필터링
            if query:
                filtered_news = [
                    news for news in news_data 
                    if query.lower() in news.get('title', '').lower() or 
                       query.lower() in news.get('summary', '').lower()
                ]
            else:
                filtered_news = news_data
            
            # 한국 뉴스와 해외 뉴스 분리
            korean_news = [news for news in filtered_news if news.get('is_korean', False)]
            foreign_news = [news for news in filtered_news if not news.get('is_korean', False)]
            
            # 한국 뉴스를 먼저, 그 다음 해외 뉴스 (최대 30건)
            combined_news = korean_news[:20] + foreign_news[:10]
            
            # 시간순 정렬
            combined_news.sort(key=lambda x: x.get('published', ''), reverse=True)
            
            # 응답 형식 맞추기
            news_list = []
            for news in combined_news[:30]:
                news_list.append({
                    'title': news.get('title', ''),
                    'content': news.get('summary', '')[:200] + '...' if len(news.get('summary', '')) > 200 else news.get('summary', ''),
                    'url': news.get('link', '#'),
                    'published_at': news.get('published', ''),
                    'sentiment_score': 0.5,  # 기본값
                    'source': news.get('source', 'Unknown'),
                    'keyword': news.get('keyword', ''),  # MCP 검색 키워드
                    'is_korean': news.get('is_korean', False)
                })
            
            print(f"/api/news: 뉴스 {len(news_list)}건 반환 (query={query}, 한국: {len(korean_news)}, 해외: {len(foreign_news)})")
            return jsonify({"success": True, "news_list": news_list})
        
        # CSV 데이터가 없으면 Supabase 시도
        if news_processor and hasattr(news_processor, 'get_news_from_supabase'):
            news_list = news_processor.get_news_from_supabase(query=query, limit=30)
            logger.debug(f"/api/news: Supabase에서 뉴스 {len(news_list)}건 반환")
            return jsonify({"success": True, "news_list": news_list})
        
    except Exception as e:
        print(f"/api/news 오류: {e}")
        # 기본 뉴스 반환 (오류 시)
        default_news = [
            {
                'title': '시장 상황 분석 중',
                'content': '현재 뉴스 데이터를 업데이트하고 있습니다. 잠시만 기다려주세요.',
                'url': '#',
                'published_at': datetime.now().isoformat(),
                'sentiment_score': 0.5,
                'source': 'System'
            }
        ]
        return jsonify({"success": True, "news_list": default_news})
```

**주요 특징**:
- 쿼리 기반 필터링 (3294-3302)
- 국내/해외 뉴스 분리 (3304-3306)
- 국내 뉴스 우선 정렬 (3308)
- Supabase 폴백 지원 (3332-3335)

### 2.3 오늘의 뉴스 API (`app.py:5129-5321`)

```python
@app.route('/api/news-today', methods=['GET'])
def api_news_today():
    """오늘의 뉴스 조회 (실시간 네이버 뉴스 우선, Supabase 폴백)"""
    try:
        # 필터 파라미터 가져오기 (domestic/global)
        filter_type = request.args.get('filter', 'domestic')
        
        # 먼저 Supabase에서 감정 분석된 뉴스 데이터 가져오기
        news_data = []
        try:
            from src.db_client import get_supabase_client
            supabase = get_supabase_client()
            
            if supabase:
                # 오늘 날짜 기준으로 뉴스 조회
                from datetime import datetime, timedelta
                today = datetime.now().date()
                yesterday = today - timedelta(days=1)
                
                # 감정 분석 데이터와 함께 뉴스 가져오기 (최신순 정렬)
                response = supabase.table('news_articles').select(
                    "*, sentiment_details!left(positive_score,negative_score,neutral_score)"
                ).gte('published_date', yesterday.isoformat()).order('published_date', desc=True).limit(50).execute()
                
                if response.data:
                    for item in response.data:
                        # 감정 정보 추가
                        sentiment_detail = item.get('sentiment_details', [])
                        if sentiment_detail:
                            sentiment_scores = sentiment_detail[0]
                            item['positive_score'] = sentiment_scores.get('positive_score', 0)
                            item['negative_score'] = sentiment_scores.get('negative_score', 0)
                        
                        # 카테고리 설정
                        if 'category' not in item or not item['category']:
                            item['category'] = '종합'
                        
                        # 링크 처리
                        if not item.get('url') or item['url'] == '#':
                            search_query = item.get('title', '').replace(' ', '+')
                            item['link'] = f"https://search.naver.com/search.naver?where=news&query={search_query}"
                        else:
                            item['link'] = item['url']
                        
                        news_data.append(item)
        except Exception as e:
            print(f"Supabase 뉴스 조회 오류: {e}")
```

---

## 3. 프론트엔드 구현

### 3.1 HTML 구조 (`news.html`)

#### 3.1.1 탭 메뉴 구조 (48-88줄)
```html
<!-- 탭 메뉴 스타일 -->
<div class="news-tabs">
    <div class="news-tabs-left">
        <button class="news-tab active" data-tab="today" onclick="switchTab('today')">
            오늘의 Pick
        </button>
        <button class="news-tab" data-tab="portfolio" onclick="switchTab('portfolio')">
            내 포트폴리오
        </button>
        <button class="news-tab" data-tab="recommend" onclick="switchTab('recommend')">
            추천
        </button>
    </div>
    <button class="news-filter-dropdown" onclick="toggleFilter()">
        <span id="filterText">국내 뉴스</span>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4z"/>
        </svg>
    </button>
</div>
```

#### 3.1.2 뉴스 캐러셀 구조 (89-166줄)
```html
<!-- 뉴스 카드 캐러셀 -->
<div class="news-carousel-wrapper">
    <!-- 이전 버튼 -->
    <div class="carousel-nav prev" onclick="moveCarousel(-1)">
        <svg viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
    </div>
    
    <!-- 다음 버튼 -->
    <div class="carousel-nav next" onclick="moveCarousel(1)">
        <svg viewBox="0 0 24 24">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
        </svg>
    </div>
    
    <div class="carousel-viewport">
        <div class="news-grid" id="newsGrid">
            <!-- 뉴스 카드들이 동적으로 생성됨 -->
        </div>
    </div>
    
    <!-- 캐러셀 인디케이터 -->
    <div class="carousel-indicators" id="carouselIndicators">
        <!-- 인디케이터들이 동적으로 생성됨 -->
    </div>
</div>
```

#### 3.1.3 뉴스 카드 템플릿 (168-227줄)
```html
<div class="news-card">
    <div class="news-card-content">
        <div class="news-category">경제</div>
        <h3 class="news-title">뉴스 제목</h3>
        <p class="news-summary">뉴스 요약 내용...</p>
        <div class="news-meta">
            <span class="news-source">뉴스 출처</span>
            <span class="news-time">2시간 전</span>
        </div>
        <div class="news-sentiment">
            <span class="sentiment-label">시장 반응</span>
            <div class="sentiment-bar">
                <div class="sentiment-fill positive" style="width: 65%"></div>
            </div>
            <span class="sentiment-score">긍정 65%</span>
        </div>
    </div>
</div>
```

### 3.2 CSS 스타일링

#### 3.2.1 캐러셀 스타일 (89-166줄)
```css
/* 뉴스 카드 캐러셀 */
.news-carousel-wrapper {
    position: relative;
    padding: 0 96px 40px;
}

.carousel-viewport {
    overflow: hidden;
    width: 100%;
    position: relative;
}

.news-grid {
    display: flex;
    gap: 16px;
    transition: transform 0.5s ease-in-out;
    padding: 0;
    width: fit-content;
    position: relative;
}

/* 캐러셀 네비게이션 버튼 */
.carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 77px;
    height: 77px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
}

.carousel-nav:hover {
    background: rgba(0, 0, 0, 0.6);
}

/* 캐러셀 인디케이터 */
.carousel-indicators {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 30px;
}

.carousel-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #E5E5E5;
    cursor: pointer;
    transition: all 0.3s ease;
}

.carousel-indicator.active {
    background: #1454FE;
    width: 24px;
    border-radius: 4px;
}
```

#### 3.2.2 뉴스 카드 스타일 (168-226줄)
```css
.news-card {
    flex: 0 0 auto;
    width: auto; /* JavaScript에서 동적으로 설정 */
    height: 400px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: block;
    border: 1px solid rgba(229, 229, 229, 0.5);
    backdrop-filter: blur(10px);
}

.news-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    background: rgba(255, 255, 255, 0.95);
}

.news-card-content {
    position: relative;
    height: 100%;
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.news-category {
    width: fit-content;
    padding: 2px 12px;
    background: #E8EEFF;
    color: #1454FE;
    font-size: 12px;
    font-weight: 500;
    border-radius: 4px;
    margin-bottom: 12px;
}
```

### 3.3 JavaScript 구현

#### 3.3.1 NewsManager 클래스
```javascript
class NewsManager {
    constructor() {
        this.currentTab = 'today';
        this.currentFilter = 'domestic';
        this.newsData = {
            today: [],
            portfolio: [],
            recommend: []
        };
        this.carouselPosition = 0;
        this.cardsPerView = 0;
        this.totalPages = 0;
        
        this.init();
    }
    
    async init() {
        // 초기 설정
        this.calculateCardsPerView();
        this.setupEventListeners();
        
        // 뉴스 로드
        await this.loadNews('today');
        
        // 리사이즈 이벤트 처리
        window.addEventListener('resize', () => {
            this.calculateCardsPerView();
            this.updateCarousel();
        });
    }
    
    calculateCardsPerView() {
        const viewport = document.querySelector('.carousel-viewport');
        const viewportWidth = viewport.offsetWidth;
        const cardWidth = 300; // 카드 너비
        const gap = 16; // 카드 간격
        
        this.cardsPerView = Math.floor(viewportWidth / (cardWidth + gap));
    }
    
    async loadNews(tab) {
        try {
            const endpoint = this.getEndpoint(tab);
            const response = await fetch(`${endpoint}?filter=${this.currentFilter}`);
            const data = await response.json();
            
            if (data.success) {
                this.newsData[tab] = data.news_list;
                this.renderNews(tab);
            }
        } catch (error) {
            console.error('뉴스 로드 실패:', error);
            this.showError('뉴스를 불러올 수 없습니다.');
        }
    }
    
    getEndpoint(tab) {
        const endpoints = {
            'today': '/api/news-today',
            'portfolio': '/api/news-portfolio',
            'recommend': '/api/news-recommend'
        };
        return endpoints[tab] || '/api/news-today';
    }
    
    renderNews(tab) {
        const newsGrid = document.getElementById('newsGrid');
        const newsList = this.newsData[tab] || [];
        
        // 카드 생성
        newsGrid.innerHTML = newsList.map((news, index) => 
            this.createNewsCard(news, index)
        ).join('');
        
        // 카드 너비 설정
        const cards = newsGrid.querySelectorAll('.news-card');
        cards.forEach(card => {
            card.style.width = '300px';
        });
        
        // 인디케이터 업데이트
        this.updateIndicators();
        
        // 캐러셀 초기화
        this.carouselPosition = 0;
        this.updateCarousel();
    }
    
    createNewsCard(news, index) {
        const sentiment = this.getSentiment(news.sentiment_score);
        const timeAgo = this.getTimeAgo(news.published_at);
        
        return `
            <a href="${news.url || '#'}" target="_blank" class="news-card" data-index="${index}">
                <div class="news-card-content">
                    <div class="news-category">${news.category || '종합'}</div>
                    <h3 class="news-title">${this.escapeHtml(news.title)}</h3>
                    <p class="news-summary">${this.escapeHtml(news.content)}</p>
                    <div class="news-meta">
                        <span class="news-source">${news.source || '픽시 뉴스'}</span>
                        <span class="news-time">${timeAgo}</span>
                    </div>
                    <div class="news-sentiment">
                        <span class="sentiment-label">시장 반응</span>
                        <div class="sentiment-bar">
                            <div class="sentiment-fill ${sentiment.class}" 
                                 style="width: ${sentiment.percentage}%"></div>
                        </div>
                        <span class="sentiment-score">${sentiment.label} ${sentiment.percentage}%</span>
                    </div>
                </div>
            </a>
        `;
    }
    
    getSentiment(score) {
        if (score >= 0.7) {
            return {
                class: 'positive',
                label: '긍정',
                percentage: Math.round(score * 100)
            };
        } else if (score <= 0.3) {
            return {
                class: 'negative',
                label: '부정',
                percentage: Math.round((1 - score) * 100)
            };
        } else {
            return {
                class: 'neutral',
                label: '중립',
                percentage: 50
            };
        }
    }
    
    getTimeAgo(dateString) {
        if (!dateString) return '방금 전';
        
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 60) return `${minutes}분 전`;
        if (hours < 24) return `${hours}시간 전`;
        if (days < 7) return `${days}일 전`;
        
        return date.toLocaleDateString('ko-KR');
    }
    
    moveCarousel(direction) {
        const newsGrid = document.getElementById('newsGrid');
        const totalCards = this.newsData[this.currentTab].length;
        
        this.totalPages = Math.ceil(totalCards / this.cardsPerView);
        
        // 다음/이전 페이지로 이동
        this.carouselPosition += direction;
        
        // 범위 제한
        if (this.carouselPosition < 0) {
            this.carouselPosition = this.totalPages - 1;
        } else if (this.carouselPosition >= this.totalPages) {
            this.carouselPosition = 0;
        }
        
        this.updateCarousel();
    }
    
    updateCarousel() {
        const newsGrid = document.getElementById('newsGrid');
        const cardWidth = 300;
        const gap = 16;
        const offset = this.carouselPosition * this.cardsPerView * (cardWidth + gap);
        
        newsGrid.style.transform = `translateX(-${offset}px)`;
        
        // 인디케이터 업데이트
        this.updateIndicators();
    }
    
    updateIndicators() {
        const container = document.getElementById('carouselIndicators');
        const totalCards = this.newsData[this.currentTab].length;
        this.totalPages = Math.ceil(totalCards / this.cardsPerView);
        
        container.innerHTML = '';
        
        for (let i = 0; i < this.totalPages; i++) {
            const indicator = document.createElement('div');
            indicator.className = `carousel-indicator ${i === this.carouselPosition ? 'active' : ''}`;
            indicator.onclick = () => {
                this.carouselPosition = i;
                this.updateCarousel();
            };
            container.appendChild(indicator);
        }
    }
    
    switchTab(tab) {
        // 탭 활성화 상태 변경
        document.querySelectorAll('.news-tab').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active');
            }
        });
        
        this.currentTab = tab;
        this.carouselPosition = 0;
        
        // 뉴스 로드
        this.loadNews(tab);
    }
    
    toggleFilter() {
        const filterText = document.getElementById('filterText');
        
        if (this.currentFilter === 'domestic') {
            this.currentFilter = 'global';
            filterText.textContent = '해외 뉴스';
        } else {
            this.currentFilter = 'domestic';
            filterText.textContent = '국내 뉴스';
        }
        
        // 현재 탭 다시 로드
        this.loadNews(this.currentTab);
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    showError(message) {
        const newsGrid = document.getElementById('newsGrid');
        newsGrid.innerHTML = `
            <div class="error-message">
                <i class="bi bi-exclamation-circle"></i>
                <p>${message}</p>
            </div>
        `;
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', () => {
    window.newsManager = new NewsManager();
});

// 전역 함수들 (HTML에서 직접 호출)
function switchTab(tab) {
    window.newsManager.switchTab(tab);
}

function moveCarousel(direction) {
    window.newsManager.moveCarousel(direction);
}

function toggleFilter() {
    window.newsManager.toggleFilter();
}
```

---

## 4. 뉴스 데이터 처리

### 4.1 실시간 뉴스 수집 (`enhanced_news_collector.py`)

```python
class EnhancedNewsCollector:
    """향상된 뉴스 수집기"""
    
    def __init__(self):
        self.sources = {
            'naver': NaverNewsCollector(),
            'rss': RSSFeedCollector(),
            'mcp': MCPNewsCollector()
        }
        self.sentiment_analyzer = NewsSentimentAnalyzer()
        
    async def collect_all_news(self):
        """모든 소스에서 뉴스 수집"""
        all_news = []
        
        # 병렬로 뉴스 수집
        tasks = []
        for source_name, collector in self.sources.items():
            tasks.append(self._collect_from_source(source_name, collector))
            
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # 결과 통합
        for result in results:
            if isinstance(result, list):
                all_news.extend(result)
                
        # 중복 제거
        unique_news = self._remove_duplicates(all_news)
        
        # 감정 분석
        analyzed_news = await self._analyze_sentiments(unique_news)
        
        return analyzed_news
```

### 4.2 데이터 매니저 (`real_data_manager.py`)

```python
class RealDataManager:
    """실제 데이터 관리자"""
    
    def load_news_data(self):
        """CSV 파일에서 뉴스 데이터 로드"""
        try:
            # 최신 뉴스 파일 찾기
            news_files = glob.glob(os.path.join(self.data_dir, 'news_*.csv'))
            if not news_files:
                return []
                
            latest_file = max(news_files, key=os.path.getctime)
            
            # CSV 읽기
            df = pd.read_csv(latest_file, encoding='utf-8-sig')
            
            # 데이터 형식 변환
            news_list = []
            for _, row in df.iterrows():
                news_item = {
                    'title': row.get('title', ''),
                    'summary': row.get('summary', ''),
                    'link': row.get('link', '#'),
                    'published': row.get('published', ''),
                    'source': row.get('source', 'Unknown'),
                    'is_korean': self._is_korean_news(row)
                }
                news_list.append(news_item)
                
            return news_list
            
        except Exception as e:
            logger.error(f"뉴스 데이터 로드 실패: {e}")
            return []
    
    def _is_korean_news(self, news_item):
        """한국 뉴스 여부 판단"""
        korean_keywords = ['한국', '국내', '코스피', '코스닥', '원화']
        title = str(news_item.get('title', ''))
        content = str(news_item.get('summary', ''))
        
        return any(keyword in title or keyword in content 
                  for keyword in korean_keywords)
```

---

## 5. API 엔드포인트

### 5.1 뉴스 키워드 관리 (`app.py:4951-5015`)

```python
@app.route('/api/news-keywords', methods=['GET', 'POST', 'DELETE'])
def api_news_keywords():
    # 세션 기반 user_id
    user_id = session.get('user_id')
    if not user_id:
        user_id = f"user_{str(uuid.uuid4())[:8]}"
        session['user_id'] = user_id
    
    # 세션에서 포트폴리오 키워드 가져오기
    portfolio_keywords = session.get('portfolio_keywords', [])
    
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    
    if request.method == 'GET':
        # DB와 세션의 키워드 합치기
        c.execute('SELECT keyword FROM news_keywords WHERE user_id=? ORDER BY created_at DESC', (user_id,))
        db_keywords = [row[0] for row in c.fetchall()]
        all_keywords = list(set(portfolio_keywords + db_keywords))
        conn.close()
        return jsonify({'success': True, 'keywords': all_keywords})
    
    elif request.method == 'POST':
        data = request.get_json()
        keyword = data.get('keyword', '').strip()
        if keyword:
            # 세션에 추가
            if keyword not in portfolio_keywords:
                portfolio_keywords.append(keyword)
                session['portfolio_keywords'] = portfolio_keywords
            
            # DB에도 저장
            c.execute('SELECT 1 FROM news_keywords WHERE user_id=? AND keyword=?', (user_id, keyword))
            if not c.fetchone():
                c.execute('INSERT INTO news_keywords (user_id, keyword) VALUES (?, ?)', (user_id, keyword))
                conn.commit()
```

### 5.2 포트폴리오 뉴스 API (`app.py:5568-5801`)

```python
@app.route('/api/news-portfolio', methods=['GET'])
def api_news_portfolio():
    """포트폴리오 관련 뉴스 조회"""
    try:
        # 필터 파라미터 가져오기
        filter_type = request.args.get('filter', 'domestic')
        
        # 세션에서 사용자 ID 가져오기
        session_id = session.get('user_id')
        
        # DB에서 사용자 관심 종목 가져오기
        portfolio_keywords = []
        if session_id:
            # SQLite에서 사용자 관심 종목 조회
            conn = sqlite3.connect(SQLITE_DB_PATH)
            cursor = conn.cursor()
            cursor.execute("""
                SELECT stock_code, stock_name FROM watchlist 
                WHERE user_id = ?
            """, (session_id,))
            watchlist = cursor.fetchall()
            conn.close()
            
            portfolio_keywords = [stock[1] for stock in watchlist]
        
        # 기본 관심 종목 설정
        if not portfolio_keywords:
            portfolio_keywords = ['삼성전자', 'SK하이닉스', 'LG에너지솔루션', '현대차', '기아']
            session['portfolio_keywords'] = portfolio_keywords
        
        # 실제 뉴스 데이터에서 포트폴리오 관련 뉴스 필터링
        news_data = real_data_manager.load_news_data()
        portfolio_news = []
        
        if news_data and len(news_data) > 0:
            for news in news_data:
                # 뉴스 필터링
                title = str(news.get('title', ''))
                content = str(news.get('content', ''))
                
                # 관심 종목 키워드 포함 여부 확인
                for keyword in portfolio_keywords:
                    if keyword in title or keyword in content:
                        portfolio_news.append(news)
                        break
```

### 5.3 뉴스 분석 API (`app.py:5908-5990`)

```python
@app.route('/api/news-analysis', methods=['POST'])
def api_news_analysis():
    """키워드 기반 뉴스 분석"""
    try:
        data = request.get_json()
        keyword = data.get('keyword', '').strip()
        
        if not keyword:
            return jsonify({'success': False, 'error': '키워드가 필요합니다.'})
        
        # Supabase에서 해당 키워드와 관련된 뉴스 검색
        supabase = get_supabase_client()
        response = supabase.table('news_data').select('*').or_(f'title.ilike.%{keyword}%,content.ilike.%{keyword}%').order('created_at', desc=True).limit(20).execute()
        
        news_list = []
        total_sentiment = 0
        positive_count = 0
        negative_count = 0
        neutral_count = 0
        
        for news in response.data:
            # 감정 점수에 따른 감정 분석
            sentiment_score = news.get('sentiment_score', 0.5)
            total_sentiment += sentiment_score
            
            if sentiment_score > 0.7:
                sentiment = '긍정'
                positive_count += 1
            elif sentiment_score < 0.3:
                sentiment = '부정'
                negative_count += 1
            else:
                sentiment = '중립'
                neutral_count += 1
```

---

## 6. UI/UX 디자인

### 6.1 반응형 디자인

```css
/* 태블릿 대응 */
@media (max-width: 1024px) {
    .news-tabs {
        padding: 24px 40px 0;
    }
    
    .news-carousel-wrapper {
        padding: 0 40px 40px;
    }
    
    .carousel-nav {
        width: 60px;
        height: 60px;
    }
    
    .news-card {
        width: 280px;
    }
}

/* 모바일 대응 */
@media (max-width: 768px) {
    .news-tabs {
        padding: 16px 20px 0;
        flex-direction: column;
        gap: 16px;
    }
    
    .news-tabs-left {
        width: 100%;
        gap: 24px;
    }
    
    .news-filter-dropdown {
        width: 100%;
        justify-content: space-between;
    }
    
    .news-carousel-wrapper {
        padding: 0 20px 30px;
    }
    
    .carousel-nav {
        display: none; /* 모바일에서는 스와이프로 대체 */
    }
    
    .news-card {
        width: calc(100vw - 60px);
    }
}
```

### 6.2 터치 스와이프 지원

```javascript
class TouchSwipeHandler {
    constructor(element) {
        this.element = element;
        this.startX = 0;
        this.currentX = 0;
        this.threshold = 50;
        
        this.init();
    }
    
    init() {
        this.element.addEventListener('touchstart', (e) => this.handleTouchStart(e));
        this.element.addEventListener('touchmove', (e) => this.handleTouchMove(e));
        this.element.addEventListener('touchend', (e) => this.handleTouchEnd(e));
    }
    
    handleTouchStart(e) {
        this.startX = e.touches[0].clientX;
    }
    
    handleTouchMove(e) {
        this.currentX = e.touches[0].clientX;
    }
    
    handleTouchEnd(e) {
        const diff = this.startX - this.currentX;
        
        if (Math.abs(diff) > this.threshold) {
            if (diff > 0) {
                // 왼쪽 스와이프 (다음)
                window.newsManager.moveCarousel(1);
            } else {
                // 오른쪽 스와이프 (이전)
                window.newsManager.moveCarousel(-1);
            }
        }
    }
}

// 모바일에서 스와이프 활성화
if ('ontouchstart' in window) {
    const carousel = document.querySelector('.carousel-viewport');
    new TouchSwipeHandler(carousel);
}
```

### 6.3 스켈레톤 로딩

```css
/* 스켈레톤 로딩 효과 */
.skeleton-card {
    background: #f0f0f0;
    border-radius: 12px;
    height: 400px;
    position: relative;
    overflow: hidden;
}

.skeleton-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    );
    animation: skeleton-loading 1.5s infinite;
}

@keyframes skeleton-loading {
    0% { left: -100%; }
    100% { left: 100%; }
}
```

---

## 7. 실시간 업데이트

### 7.1 자동 새로고침

```javascript
class AutoRefreshManager {
    constructor(interval = 300000) { // 5분
        this.interval = interval;
        this.timer = null;
        this.lastUpdate = new Date();
    }
    
    start() {
        this.timer = setInterval(() => {
            this.refresh();
        }, this.interval);
    }
    
    stop() {
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
    }
    
    async refresh() {
        try {
            // 현재 탭의 뉴스 다시 로드
            await window.newsManager.loadNews(window.newsManager.currentTab);
            
            // 업데이트 시간 표시
            this.showUpdateTime();
            
        } catch (error) {
            console.error('자동 새로고침 실패:', error);
        }
    }
    
    showUpdateTime() {
        const updateEl = document.getElementById('lastUpdate');
        if (updateEl) {
            updateEl.textContent = `마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR')}`;
        }
    }
}

// 자동 새로고침 시작
const autoRefresh = new AutoRefreshManager();
autoRefresh.start();

// 페이지 비활성화 시 중지
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        autoRefresh.stop();
    } else {
        autoRefresh.start();
    }
});
```

### 7.2 실시간 알림

```javascript
class NewsNotificationManager {
    constructor() {
        this.permission = 'default';
        this.keywords = [];
        
        this.init();
    }
    
    async init() {
        // 알림 권한 요청
        if ('Notification' in window && Notification.permission === 'default') {
            this.permission = await Notification.requestPermission();
        }
        
        // 사용자 키워드 로드
        await this.loadKeywords();
    }
    
    async loadKeywords() {
        try {
            const response = await fetch('/api/news-keywords');
            const data = await response.json();
            if (data.success) {
                this.keywords = data.keywords;
            }
        } catch (error) {
            console.error('키워드 로드 실패:', error);
        }
    }
    
    checkNewsForKeywords(newsList) {
        if (this.permission !== 'granted' || this.keywords.length === 0) {
            return;
        }
        
        for (const news of newsList) {
            const title = news.title.toLowerCase();
            const content = news.content.toLowerCase();
            
            for (const keyword of this.keywords) {
                if (title.includes(keyword.toLowerCase()) || 
                    content.includes(keyword.toLowerCase())) {
                    this.showNotification(news, keyword);
                    break;
                }
            }
        }
    }
    
    showNotification(news, keyword) {
        const notification = new Notification('픽시 뉴스 알림', {
            body: `${keyword} 관련 뉴스: ${news.title}`,
            icon: '/static/images/pixie-icon.png',
            tag: news.id || news.title,
            requireInteraction: false
        });
        
        notification.onclick = () => {
            window.open(news.url || '#', '_blank');
            notification.close();
        };
    }
}
```

---

## 8. 감정 분석

### 8.1 AI 감정 분석기 (`news_sentiment_analyzer.py`)

```python
class NewsSentimentAnalyzer:
    """뉴스 감정 분석기"""
    
    def __init__(self):
        self.llm_service = LLMService()
        self.sentiment_prompt = """
        다음 뉴스 기사의 시장 감정을 분석해주세요.
        
        뉴스 제목: {title}
        뉴스 내용: {content}
        
        다음 형식으로 응답해주세요:
        {{
            "sentiment": "positive|negative|neutral",
            "score": 0.0-1.0,
            "reasoning": "분석 근거"
        }}
        """
    
    async def analyze_sentiment(self, news_item):
        """단일 뉴스 감정 분석"""
        try:
            prompt = self.sentiment_prompt.format(
                title=news_item['title'],
                content=news_item['content'][:500]  # 토큰 제한
            )
            
            response = await self.llm_service.chat_completion([
                {"role": "system", "content": "당신은 금융 뉴스 감정 분석 전문가입니다."},
                {"role": "user", "content": prompt}
            ])
            
            # JSON 파싱
            result = json.loads(response)
            
            return {
                'sentiment': result['sentiment'],
                'sentiment_score': result['score'],
                'reasoning': result['reasoning']
            }
            
        except Exception as e:
            logger.error(f"감정 분석 실패: {e}")
            return {
                'sentiment': 'neutral',
                'sentiment_score': 0.5,
                'reasoning': 'Analysis failed'
            }
    
    async def batch_analyze(self, news_list):
        """배치 감정 분석"""
        tasks = []
        for news in news_list:
            tasks.append(self.analyze_sentiment(news))
            
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # 결과 병합
        for i, result in enumerate(results):
            if isinstance(result, dict):
                news_list[i].update(result)
            else:
                # 오류 시 기본값
                news_list[i].update({
                    'sentiment': 'neutral',
                    'sentiment_score': 0.5
                })
                
        return news_list
```

### 8.2 감정 시각화

```javascript
class SentimentVisualizer {
    constructor() {
        this.chart = null;
    }
    
    renderSentimentChart(sentimentData) {
        const ctx = document.getElementById('sentimentChart').getContext('2d');
        
        if (this.chart) {
            this.chart.destroy();
        }
        
        this.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['긍정', '부정', '중립'],
                datasets: [{
                    data: [
                        sentimentData.positive,
                        sentimentData.negative,
                        sentimentData.neutral
                    ],
                    backgroundColor: [
                        '#4CAF50',
                        '#F44336',
                        '#9E9E9E'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${percentage}%`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    updateSentimentBar(element, score) {
        const bar = element.querySelector('.sentiment-fill');
        const label = element.querySelector('.sentiment-score');
        
        if (score >= 0.7) {
            bar.className = 'sentiment-fill positive';
            label.textContent = `긍정 ${Math.round(score * 100)}%`;
        } else if (score <= 0.3) {
            bar.className = 'sentiment-fill negative';
            label.textContent = `부정 ${Math.round((1 - score) * 100)}%`;
        } else {
            bar.className = 'sentiment-fill neutral';
            label.textContent = '중립 50%';
        }
        
        bar.style.width = `${score * 100}%`;
    }
}
```

---

## 9. 성능 최적화

### 9.1 이미지 지연 로딩

```javascript
class LazyImageLoader {
    constructor() {
        this.imageObserver = null;
        this.init();
    }
    
    init() {
        if ('IntersectionObserver' in window) {
            this.imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.dataset.src;
                        
                        if (src) {
                            img.src = src;
                            img.classList.add('loaded');
                            this.imageObserver.unobserve(img);
                        }
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });
        }
    }
    
    observe(element) {
        if (this.imageObserver && element) {
            this.imageObserver.observe(element);
        }
    }
}
```

### 9.2 가상 스크롤

```javascript
class VirtualScroll {
    constructor(container, itemHeight = 120) {
        this.container = container;
        this.itemHeight = itemHeight;
        this.items = [];
        this.visibleRange = { start: 0, end: 0 };
        this.scrollTop = 0;
        
        this.init();
    }
    
    init() {
        this.container.addEventListener('scroll', () => {
            this.handleScroll();
        });
        
        this.updateVisibleRange();
    }
    
    setItems(items) {
        this.items = items;
        this.render();
    }
    
    handleScroll() {
        this.scrollTop = this.container.scrollTop;
        this.updateVisibleRange();
        this.render();
    }
    
    updateVisibleRange() {
        const containerHeight = this.container.clientHeight;
        const start = Math.floor(this.scrollTop / this.itemHeight);
        const end = Math.ceil((this.scrollTop + containerHeight) / this.itemHeight);
        
        this.visibleRange = {
            start: Math.max(0, start - 5), // 버퍼
            end: Math.min(this.items.length, end + 5)
        };
    }
    
    render() {
        const fragment = document.createDocumentFragment();
        
        // 가상 스페이서
        const topSpacer = document.createElement('div');
        topSpacer.style.height = `${this.visibleRange.start * this.itemHeight}px`;
        fragment.appendChild(topSpacer);
        
        // 보이는 아이템만 렌더링
        for (let i = this.visibleRange.start; i < this.visibleRange.end; i++) {
            const item = this.items[i];
            const element = this.createItemElement(item);
            fragment.appendChild(element);
        }
        
        // 하단 스페이서
        const bottomSpacer = document.createElement('div');
        const remainingItems = this.items.length - this.visibleRange.end;
        bottomSpacer.style.height = `${remainingItems * this.itemHeight}px`;
        fragment.appendChild(bottomSpacer);
        
        // DOM 업데이트
        this.container.innerHTML = '';
        this.container.appendChild(fragment);
    }
    
    createItemElement(item) {
        const div = document.createElement('div');
        div.className = 'news-list-item';
        div.style.height = `${this.itemHeight}px`;
        div.innerHTML = `
            <h4>${item.title}</h4>
            <p>${item.summary}</p>
            <div class="news-meta">
                <span>${item.source}</span>
                <span>${item.time}</span>
            </div>
        `;
        return div;
    }
}
```

### 9.3 캐싱 전략

```javascript
class NewsCache {
    constructor() {
        this.cache = new Map();
        this.maxAge = 5 * 60 * 1000; // 5분
        this.maxSize = 100;
    }
    
    get(key) {
        const item = this.cache.get(key);
        
        if (!item) return null;
        
        // 만료 확인
        if (Date.now() - item.timestamp > this.maxAge) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    set(key, data) {
        // 크기 제한
        if (this.cache.size >= this.maxSize) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        
        this.cache.set(key, {
            data,
            timestamp: Date.now()
        });
    }
    
    clear() {
        this.cache.clear();
    }
    
    generateKey(params) {
        return JSON.stringify(params);
    }
}

// 사용 예시
const newsCache = new NewsCache();

async function fetchNewsWithCache(tab, filter) {
    const cacheKey = newsCache.generateKey({ tab, filter });
    const cached = newsCache.get(cacheKey);
    
    if (cached) {
        return cached;
    }
    
    const response = await fetch(`/api/news-${tab}?filter=${filter}`);
    const data = await response.json();
    
    if (data.success) {
        newsCache.set(cacheKey, data);
    }
    
    return data;
}
```

---

## 10. 데이터 소스 통합

### 10.1 멀티 소스 수집기

```python
class MultiSourceNewsCollector:
    """다중 소스 뉴스 수집기"""
    
    def __init__(self):
        self.collectors = {
            'naver': NaverFinanceCollector(),
            'daum': DaumFinanceCollector(),
            'rss': RSSFeedCollector(),
            'api': ExternalAPICollector()
        }
        
    async def collect_from_all_sources(self):
        """모든 소스에서 뉴스 수집"""
        all_news = []
        
        # 동시 수집
        tasks = []
        for name, collector in self.collectors.items():
            task = asyncio.create_task(
                self._safe_collect(name, collector)
            )
            tasks.append(task)
            
        results = await asyncio.gather(*tasks)
        
        # 결과 통합
        for news_list in results:
            if news_list:
                all_news.extend(news_list)
                
        # 중복 제거 및 정렬
        unique_news = self._deduplicate(all_news)
        sorted_news = sorted(
            unique_news, 
            key=lambda x: x.get('published_at', ''), 
            reverse=True
        )
        
        return sorted_news
    
    async def _safe_collect(self, name, collector):
        """안전한 수집 (오류 처리)"""
        try:
            logger.info(f"{name} 수집 시작")
            news = await collector.collect()
            logger.info(f"{name} 수집 완료: {len(news)}건")
            return news
        except Exception as e:
            logger.error(f"{name} 수집 실패: {e}")
            return []
    
    def _deduplicate(self, news_list):
        """중복 뉴스 제거"""
        seen = set()
        unique = []
        
        for news in news_list:
            # 제목 기반 중복 확인
            title_hash = hashlib.md5(
                news['title'].encode()
            ).hexdigest()
            
            if title_hash not in seen:
                seen.add(title_hash)
                unique.append(news)
                
        return unique
```

### 10.2 데이터 통합 파이프라인

```python
class NewsDataPipeline:
    """뉴스 데이터 처리 파이프라인"""
    
    def __init__(self):
        self.collector = MultiSourceNewsCollector()
        self.analyzer = NewsSentimentAnalyzer()
        self.storage = NewsStorageManager()
        
    async def run_pipeline(self):
        """전체 파이프라인 실행"""
        try:
            # 1. 수집
            logger.info("뉴스 수집 시작")
            raw_news = await self.collector.collect_from_all_sources()
            
            # 2. 전처리
            logger.info("뉴스 전처리")
            processed_news = self._preprocess(raw_news)
            
            # 3. 감정 분석
            logger.info("감정 분석 시작")
            analyzed_news = await self.analyzer.batch_analyze(processed_news)
            
            # 4. 저장
            logger.info("데이터 저장")
            await self.storage.save_batch(analyzed_news)
            
            # 5. 통계 생성
            stats = self._generate_statistics(analyzed_news)
            
            logger.info(f"파이프라인 완료: {len(analyzed_news)}건 처리")
            return stats
            
        except Exception as e:
            logger.error(f"파이프라인 오류: {e}")
            raise
    
    def _preprocess(self, news_list):
        """뉴스 전처리"""
        processed = []
        
        for news in news_list:
            # 텍스트 정제
            news['title'] = self._clean_text(news['title'])
            news['content'] = self._clean_text(news['content'])
            
            # 메타데이터 추가
            news['processed_at'] = datetime.now().isoformat()
            news['word_count'] = len(news['content'].split())
            
            processed.append(news)
            
        return processed
    
    def _clean_text(self, text):
        """텍스트 정제"""
        # HTML 태그 제거
        text = re.sub(r'<[^>]+>', '', text)
        # 특수문자 정규화
        text = re.sub(r'\s+', ' ', text)
        return text.strip()
```

---

## 마무리

뉴스/이슈 페이지는 실시간 금융 뉴스와 AI 기반 감정 분석을 제공하는 핵심 기능입니다. 주요 특징:

1. **다중 소스 통합**: 네이버, RSS, MCP 등 다양한 뉴스 소스
2. **AI 감정 분석**: 실시간 시장 심리 파악
3. **맞춤형 필터링**: 사용자 포트폴리오 기반 뉴스 추천
4. **캐러셀 UI**: 직관적인 뉴스 브라우징 경험
5. **성능 최적화**: 캐싱, 지연 로딩, 가상 스크롤

이 문서는 뉴스/이슈 페이지의 전체 구현을 상세히 다루며, 향후 유지보수와 확장을 위한 기술적 참고 자료로 활용될 수 있습니다.