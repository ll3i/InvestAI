# 04_AIì±—ë´‡_ìƒì„¸.md - AI ì±—ë´‡ í˜ì´ì§€ ê°œë°œ ë¬¸ì„œ

## ëª©ì°¨
1. [í˜ì´ì§€ ê°œìš”](#1-í˜ì´ì§€-ê°œìš”)
2. [ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ](#2-ë©€í‹°-ì—ì´ì „íŠ¸-ì‹œìŠ¤í…œ)
3. [ë°±ì—”ë“œ êµ¬í˜„](#3-ë°±ì—”ë“œ-êµ¬í˜„)
4. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„](#4-í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„)
5. [ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°](#5-ì‹¤ì‹œê°„-ìŠ¤íŠ¸ë¦¬ë°)
6. [ìƒíƒœ ê´€ë¦¬](#6-ìƒíƒœ-ê´€ë¦¬)
7. [UI/UX ë””ìì¸](#7-uiux-ë””ìì¸)
8. [ì—ëŸ¬ ì²˜ë¦¬](#8-ì—ëŸ¬-ì²˜ë¦¬)
9. [ì„±ëŠ¥ ìµœì í™”](#9-ì„±ëŠ¥-ìµœì í™”)
10. [ë³´ì•ˆ ë° í”„ë¼ì´ë²„ì‹œ](#10-ë³´ì•ˆ-ë°-í”„ë¼ì´ë²„ì‹œ)

---

## 1. í˜ì´ì§€ ê°œìš”

### 1.1 ëª©ì 
ê°œì¸í™”ëœ AI íˆ¬ì ìƒë‹´ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” í•µì‹¬ ê¸°ëŠ¥. ì‚¬ìš©ìì˜ íˆ¬ì ì„±í–¥ì„ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• íˆ¬ì ì¡°ì–¸ì„ ì œê³µí•˜ë©°, ì‹¤ì‹œê°„ ê¸ˆìœµ ë°ì´í„°ë¥¼ í™œìš©í•œ êµ¬ì²´ì ì¸ íˆ¬ì ì „ëµì„ ì œì‹œí•©ë‹ˆë‹¤.

### 1.2 ì£¼ìš” ê¸°ëŠ¥
- **ë©€í‹° ì—ì´ì „íŠ¸ AI ì‹œìŠ¤í…œ**: AI-A â†’ AI-A2 â†’ AI-B â†’ Final Response ì²´ì¸
- **ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°**: SSE(Server-Sent Events) ê¸°ë°˜ ì‹¤ì‹œê°„ ì‘ë‹µ
- **ê°œì¸í™” ìƒë‹´**: íˆ¬ì ì„±í–¥ ê¸°ë°˜ ë§ì¶¤í˜• ì¡°ì–¸
- **ê¸ˆìœµ ë°ì´í„° í†µí•©**: ì‹¤ì‹œê°„ ì£¼ê°€, ë‰´ìŠ¤, ì¬ë¬´ì œí‘œ í™œìš©
- **ëŒ€í™” ê¸°ë¡ ê´€ë¦¬**: ì„¸ì…˜ë³„ ëŒ€í™” ì €ì¥ ë° ì»¨í…ìŠ¤íŠ¸ ìœ ì§€

### 1.3 íŒŒì¼ êµ¬ì¡°
```
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ app.py                        # API ì—”ë“œí¬ì¸íŠ¸
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ chatbot.html              # ì±—ë´‡ UI
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ investment_advisor.py         # í•µì‹¬ AI ì—ì´ì „íŠ¸ ì²´ì¸
â”‚   â”œâ”€â”€ llm_service.py               # LLM API ì¶”ìƒí™”
â”‚   â”œâ”€â”€ memory_manager.py            # ëŒ€í™” ë©”ëª¨ë¦¬ ê´€ë¦¬
â”‚   â”œâ”€â”€ user_profile_analyzer.py     # ì‚¬ìš©ì í”„ë¡œí•„ ë¶„ì„
â”‚   â””â”€â”€ financial_data_processor.py  # ê¸ˆìœµ ë°ì´í„° ì²˜ë¦¬
â””â”€â”€ prompts/
    â”œâ”€â”€ prompt_AI-A.txt              # AI-A í”„ë¡¬í”„íŠ¸
    â”œâ”€â”€ prompt_AI-A2.txt             # AI-A2 í”„ë¡¬í”„íŠ¸
    â””â”€â”€ prompt_AI-B.txt              # AI-B í”„ë¡¬í”„íŠ¸
```

---

## 2. ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ

### 2.1 ì—ì´ì „íŠ¸ ì²´ì¸ ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ì…ë ¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI-A      â”‚ â† íˆ¬ì ì„±í–¥ ê¸°ë°˜ ì´ˆê¸° ì‘ë‹µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI-A2     â”‚ â† ì§ˆë¬¸ ëª…í™•í™” ë° ë°ì´í„° ìš”ì²­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI-B      â”‚ â† ì‹¤ì‹œê°„ ê¸ˆìœµ ë°ì´í„° ë¶„ì„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Final Responseâ”‚ â† í†µí•©ëœ ìµœì¢… ì‘ë‹µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
ì‚¬ìš©ìì—ê²Œ ì „ë‹¬
```

### 2.2 ì—ì´ì „íŠ¸ë³„ ì—­í• 

#### 2.2.1 AI-A (ì´ˆê¸° ì‘ë‹µ ì—ì´ì „íŠ¸)
```python
# investment_advisor.py:164-203
# AI-A: ì‚¬ìš©ì ì„±í–¥ ê¸°ë°˜ ì´ˆê¸° íˆ¬ì ì¡°ì–¸
ai_a_messages = [
    {"role": "system", "content": ai_a_prompt},
    {"role": "user", "content": user_input}
]

self._update_status("AI-A: íˆ¬ì ì„±í–¥ ë¶„ì„ ì¤‘...")
ai_a_response = self.llm_service.chat_completion(ai_a_messages)
self.memory_manager.save_memory("AI-A", ai_a_response)
```

**ì—­í• **:
- ì‚¬ìš©ìì˜ íˆ¬ì ì„±í–¥ ë¶„ì„
- ë§ì¶¤í˜• ì´ˆê¸° ì¡°ì–¸ ìƒì„±
- íˆ¬ì ì‹¬ë¦¬ ê³ ë ¤

#### 2.2.2 AI-A2 (ì§ˆë¬¸ ëª…í™•í™” ì—ì´ì „íŠ¸)
```python
# investment_advisor.py:205-247
# AI-A2: AI-A ì‘ë‹µ ê¸°ë°˜ ì§ˆë¬¸ ëª…í™•í™”
ai_a2_prompt = self._prepare_ai_a2_prompt(user_profile)
ai_a2_messages = [
    {"role": "system", "content": ai_a2_prompt},
    {"role": "user", "content": f"ì‚¬ìš©ì ì§ˆë¬¸: {user_input}"},
    {"role": "assistant", "content": ai_a_response},
    {"role": "user", "content": "ì´ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ AI-Bì—ê²Œ í•„ìš”í•œ ê¸ˆìœµ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”."}
]
```

**ì—­í• **:
- AI-A ì‘ë‹µ ë¶„ì„
- êµ¬ì²´ì ì¸ ë°ì´í„° ìš”ì²­ ìƒì„±
- AI-Bì™€ì˜ ë¸Œë¦¿ì§€ ì—­í• 

#### 2.2.3 AI-B (ë°ì´í„° ë¶„ì„ ì—ì´ì „íŠ¸)
```python
# investment_advisor.py:249-291
# AI-B: ì‹¤ì‹œê°„ ê¸ˆìœµ ë°ì´í„° ì œê³µ
ai_b_prompt = self._prepare_ai_b_prompt()
ai_b_messages = [
    {"role": "system", "content": ai_b_prompt},
    {"role": "user", "content": ai_a2_response}
]

self._update_status("AI-B: ê¸ˆìœµ ë°ì´í„° ë¶„ì„ ì¤‘...")
ai_b_response = self.llm_service.chat_completion(ai_b_messages)
```

**ì—­í• **:
- ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ë¶„ì„
- ì¬ë¬´ì œí‘œ ë° ê¸°ìˆ ì  ë¶„ì„
- ê°ê´€ì  ë°ì´í„° ì œê³µ

#### 2.2.4 Final Response (í†µí•© ì—ì´ì „íŠ¸)
```python
# investment_advisor.py:293-341
# ìµœì¢… ì‘ë‹µ: ëª¨ë“  AI ì‘ë‹µ í†µí•©
final_messages = [
    {"role": "system", "content": self._prepare_final_prompt(user_profile)},
    {"role": "user", "content": f"ì›ë˜ ì§ˆë¬¸: {user_input}"},
    {"role": "assistant", "content": f"AI-A ë¶„ì„: {ai_a_response}"},
    {"role": "assistant", "content": f"AI-B ë°ì´í„°: {ai_b_response}"},
    {"role": "user", "content": "ìœ„ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… íˆ¬ì ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”."}
]
```

---

## 3. ë°±ì—”ë“œ êµ¬í˜„

### 3.1 ë©”ì¸ ì±—ë´‡ ë¼ìš°íŠ¸ (`app.py:1284-1287`)

```python
@app.route('/chatbot')
def chatbot():
    """ì±—ë´‡ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤."""
    return render_template('chatbot.html')
```

### 3.2 ì±—ë´‡ API ì—”ë“œí¬ì¸íŠ¸ (`app.py:2272-2444`)

```python
@app.route('/api/chat', methods=['POST'])
def chat():
    """MINERVA ì±—ë´‡ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤."""
    try:
        data = request.json
        message = data.get('message', '').strip()
        session_id = session.get('user_id')
        if not session_id:
            session_id = f"user_{str(uuid.uuid4())[:8]}"
            session['user_id'] = session_id
            
        # 1. ì„¤ë¬¸ ê²°ê³¼ ì¡°íšŒ
        from src.db_client import get_supabase_client
        supabase = get_supabase_client()
        
        has_profile = False
        profile_json = None
        summary = None
        
        if supabase:
            try:
                res = supabase.table("user_profiles").select("profile_json,summary").eq("user_id", session_id).order("created_at", desc=True).limit(1).execute()
                has_profile = res.data and len(res.data) > 0
                profile_json = res.data[0]['profile_json'] if has_profile else None
                summary = res.data[0]['summary'] if has_profile else None
            except Exception as e:
                logger.error(f"Supabase ì¡°íšŒ ì˜¤ë¥˜: {e}")
                # SQLite í´ë°± (2299-2315)
                
        # 2. ì„¤ë¬¸ ë¯¸ì™„ë£Œ ì‹œ ì•ˆë‚´
        if not has_profile:
            return jsonify({
                "success": False,
                "require_survey": True,
                "message": "ë¨¼ì € íˆ¬ì ì„±í–¥ ì„¤ë¬¸ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”!"
            })
            
        # 3. InvestmentAdvisor ì´ˆê¸°í™”
        from src.investment_advisor import InvestmentAdvisor
        from src.llm_service import get_optimal_api_type
        api_type = get_optimal_api_type()
        
        # Financial processor ì´ˆê¸°í™”
        from src.financial_data_processor import FinancialDataProcessor
        financial_processor = FinancialDataProcessor()
        
        advisor = InvestmentAdvisor(api_type=api_type, financial_processor=financial_processor)
        advisor.set_session_id(session_id)
        
        # 4. ì‚¬ìš©ì í”„ë¡œí•„ ì„¤ì •
        if profile_json:
            advisor.memory_manager.set_user_profile(profile_json)
            
        # 5. AI ì‘ë‹µ ìƒì„±
        try:
            response = advisor.chat(message)
            
            # 6. ëŒ€í™” ê¸°ë¡ ì €ì¥
            if supabase:
                supabase.table("chat_history").insert({
                    "user_id": session_id,
                    "message": message,
                    "response": response,
                    "created_at": datetime.now().isoformat()
                }).execute()
                
            return jsonify({
                "success": True,
                "response": response,
                "session_id": session_id
            })
            
        except Exception as e:
            logger.error(f"AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨: {e}")
            return jsonify({
                "success": False,
                "error": str(e)
            })
            
    except Exception as e:
        logger.error(f"ì±„íŒ… API ì˜¤ë¥˜: {e}")
        return jsonify({
            "success": False,
            "error": "ì±„íŒ… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        })
```

**ì£¼ìš” ì²˜ë¦¬ íë¦„**:
1. ì„¸ì…˜ ID í™•ì¸ ë° ìƒì„± (2278-2281)
2. ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ (2283-2315)
3. ì„¤ë¬¸ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (2362-2368)
4. InvestmentAdvisor ì´ˆê¸°í™” (2371-2380)
5. AI ì‘ë‹µ ìƒì„± (2390-2391)
6. ëŒ€í™” ê¸°ë¡ ì €ì¥ (2394-2400)

### 3.3 ìŠ¤íŠ¸ë¦¬ë° API (`app.py:3934-4080`)

```python
@app.route('/api/chat-stream')
def chat_stream():
    """SSE (Server-Sent Events) í˜•ì‹ìœ¼ë¡œ AI ì‘ë‹µì„ ìŠ¤íŠ¸ë¦¬ë°í•©ë‹ˆë‹¤."""
    from flask import Response, stream_with_context
    
    message = request.args.get('message', '').strip()
    session_id = session.get('user_id')
    if not session_id:
        session_id = f"user_{str(uuid.uuid4())[:8]}"
        session['user_id'] = session_id
    
    def generate():
        try:
            # 1. í”„ë¡œí•„ í™•ì¸
            has_profile = check_user_profile(session_id)
            
            if not has_profile:
                yield f"data: {json.dumps({'content': 'ë¨¼ì € íˆ¬ì ì„±í–¥ ì„¤ë¬¸ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”!', 'require_survey': True})}\n\n"
                yield "event: complete\ndata: {}\n\n"
                return
                
            # 2. InvestmentAdvisor ì´ˆê¸°í™”
            advisor = InvestmentAdvisor(api_type=api_type, financial_processor=financial_processor)
            advisor.set_session_id(session_id)
            
            # 3. ì½œë°± ì„¤ì •
            def status_callback(agent, status):
                yield f"event: status\ndata: {json.dumps({'agent': agent, 'status': status})}\n\n"
                
            def response_callback(agent, response):
                yield f"event: agent\ndata: {json.dumps({'agent': agent, 'response': response})}\n\n"
                
            advisor.set_status_callback(status_callback)
            advisor.set_response_callback(response_callback)
            
            # 4. ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„±
            response = advisor.chat(message)
            
            # 5. ìµœì¢… ì‘ë‹µ ì „ì†¡
            yield f"data: {json.dumps({'content': response})}\n\n"
            yield "event: complete\ndata: {}\n\n"
            
        except Exception as e:
            yield f"event: error\ndata: {json.dumps({'error': str(e)})}\n\n"
    
    return Response(
        stream_with_context(generate()),
        mimetype="text/event-stream",
        headers={
            'Cache-Control': 'no-cache',
            'X-Accel-Buffering': 'no'
        }
    )
```

**SSE ì´ë²¤íŠ¸ íƒ€ì…**:
- `status`: ì—ì´ì „íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
- `agent`: ì—ì´ì „íŠ¸ë³„ ì‘ë‹µ
- `data`: ìµœì¢… ì‘ë‹µ ì½˜í…ì¸ 
- `complete`: ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ
- `error`: ì˜¤ë¥˜ ë°œìƒ

---

## 4. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 4.1 HTML êµ¬ì¡° (`chatbot.html`)

#### 4.1.1 ì±„íŒ… ì»¨í…Œì´ë„ˆ (8-28ì¤„)
```html
<div class="pixie-chatbot-container">
    <div class="pixie-chat-wrapper">
        <!-- í—¤ë” -->
        <div class="pixie-chat-header">
            <div class="pixie-chat-avatar">ğŸ¤–</div>
            <div class="pixie-chat-info">
                <h2>Pixie AI íˆ¬ì ì–´ë“œë°”ì´ì €</h2>
                <p>ë§ì¶¤í˜• íˆ¬ì ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤</p>
            </div>
            <button class="pixie-chat-close" onclick="window.history.back()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="pixie-chat-messages" id="chatMessages">
            <!-- ë™ì ìœ¼ë¡œ ë©”ì‹œì§€ ì¶”ê°€ -->
        </div>
        
        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="pixie-chat-input-container">
            <input type="text" class="pixie-chat-input" id="chatInput" 
                   placeholder="íˆ¬ìì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
            <button class="pixie-chat-send" id="sendButton">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>
```

#### 4.1.2 ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (110-221ì¤„)
```css
/* ì‚¬ìš©ì ë©”ì‹œì§€ */
.pixie-message-user {
    background: var(--gradient-primary);
    color: white;
    padding: 16px 20px;
    border-radius: 20px 20px 4px 20px;
    margin-left: auto;
    box-shadow: var(--shadow-sm);
}

/* AI ë©”ì‹œì§€ */
.pixie-message-ai {
    background: white;
    color: var(--text-primary);
    padding: 16px 20px;
    border-radius: 20px 20px 20px 4px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

/* ì—ì´ì „íŠ¸ë³„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
.pixie-message-agent {
    background: #f0f7ff;
    border: 1px solid #cce5ff;
}

.pixie-message-agent.agent-a2 {
    background: #fff5e6;
    border-color: #ffd6a5;
}

.pixie-message-agent.agent-b {
    background: #e6f9f5;
    border-color: #a5e5d6;
}

/* ì—ì´ì „íŠ¸ ë¼ë²¨ */
.agent-label {
    font-weight: 700;
    color: #1454FE;
    font-size: 13px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.agent-label .agent-icon {
    width: 20px;
    height: 20px;
    background: #1454FE;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 900;
}
```

### 4.2 JavaScript êµ¬í˜„

#### 4.2.1 ChatbotManager í´ë˜ìŠ¤
```javascript
class ChatbotManager {
    constructor() {
        this.messageContainer = document.getElementById('chatMessages');
        this.inputField = document.getElementById('chatInput');
        this.sendButton = document.getElementById('sendButton');
        this.isProcessing = false;
        this.eventSource = null;
        this.currentAgentMessages = {};
        
        this.init();
    }
    
    init() {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !this.isProcessing) {
                this.sendMessage();
            }
        });
        
        // ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
        this.showWelcomeMessage();
        
        // ì„¸ì…˜ ë³µêµ¬
        this.loadChatHistory();
    }
    
    showWelcomeMessage() {
        const welcomeMsg = `ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Pixie AI íˆ¬ì ì–´ë“œë°”ì´ì €ì…ë‹ˆë‹¤. 
        íˆ¬ìì— ê´€í•œ ê¶ê¸ˆí•œ ì ì„ í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”. ğŸ˜Š`;
        this.addMessage(welcomeMsg, 'ai');
    }
    
    async sendMessage() {
        const message = this.inputField.value.trim();
        if (!message || this.isProcessing) return;
        
        this.isProcessing = true;
        this.inputField.value = '';
        this.inputField.disabled = true;
        this.sendButton.disabled = true;
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        this.addMessage(message, 'user');
        
        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        this.showTypingIndicator();
        
        try {
            // SSE ì—°ê²° ì‹œì‘
            await this.startStreaming(message);
        } catch (error) {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            this.showError('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            this.isProcessing = false;
            this.inputField.disabled = false;
            this.sendButton.disabled = false;
            this.inputField.focus();
        }
    }
    
    async startStreaming(message) {
        const url = `/api/chat-stream?message=${encodeURIComponent(message)}`;
        
        this.eventSource = new EventSource(url);
        
        this.eventSource.addEventListener('status', (event) => {
            const data = JSON.parse(event.data);
            this.updateAgentStatus(data.agent, data.status);
        });
        
        this.eventSource.addEventListener('agent', (event) => {
            const data = JSON.parse(event.data);
            this.showAgentMessage(data.agent, data.response);
        });
        
        this.eventSource.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            if (data.content) {
                this.hideTypingIndicator();
                this.addMessage(data.content, 'ai');
            }
            if (data.require_survey) {
                this.showSurveyPrompt();
            }
        });
        
        this.eventSource.addEventListener('complete', () => {
            this.eventSource.close();
            this.hideTypingIndicator();
            this.saveChatHistory();
        });
        
        this.eventSource.addEventListener('error', (event) => {
            console.error('SSE ì˜¤ë¥˜:', event);
            this.eventSource.close();
            this.hideTypingIndicator();
            this.showError('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        });
    }
    
    addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `pixie-message pixie-message-${type}`;
        
        if (type === 'ai') {
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${this.formatMessage(content)}
                </div>
                <div class="message-time">${this.getCurrentTime()}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-content">${this.escapeHtml(content)}</div>
                <div class="message-time">${this.getCurrentTime()}</div>
            `;
        }
        
        this.messageContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    showAgentMessage(agent, response) {
        // ì—ì´ì „íŠ¸ë³„ ë©”ì‹œì§€ í‘œì‹œ
        const agentConfig = {
            'AI-A': { class: 'agent-a', label: 'AI-A', icon: 'A' },
            'AI-A2': { class: 'agent-a2', label: 'AI-A2', icon: 'A2' },
            'AI-B': { class: 'agent-b', label: 'AI-B', icon: 'B' }
        };
        
        const config = agentConfig[agent] || { class: '', label: agent, icon: '?' };
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `pixie-message pixie-message-agent ${config.class}`;
        messageDiv.innerHTML = `
            <div class="agent-label">
                <span class="agent-icon">${config.icon}</span>
                ${config.label}
            </div>
            <div class="message-content">
                ${this.formatMessage(response)}
            </div>
        `;
        
        this.messageContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    updateAgentStatus(agent, status) {
        // ìƒíƒœ í‘œì‹œ (ì˜ˆ: "AI-Aê°€ ë¶„ì„ ì¤‘...")
        const statusDiv = document.getElementById(`status-${agent}`);
        if (statusDiv) {
            statusDiv.textContent = `${agent}: ${status}`;
        }
    }
    
    showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'pixie-typing-indicator';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = `
            <div class="pixie-typing-dot"></div>
            <div class="pixie-typing-dot"></div>
            <div class="pixie-typing-dot"></div>
        `;
        this.messageContainer.appendChild(indicator);
        this.scrollToBottom();
    }
    
    hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    formatMessage(content) {
        // ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ë³€í™˜
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>')
            .replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>')
            .replace(/`(.*?)`/g, '<code>$1</code>');
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    getCurrentTime() {
        return new Date().toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    scrollToBottom() {
        this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
    }
    
    showSurveyPrompt() {
        const promptDiv = document.createElement('div');
        promptDiv.className = 'survey-prompt';
        promptDiv.innerHTML = `
            <p>íˆ¬ì ì„±í–¥ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <a href="/survey" class="btn btn-primary">ì„¤ë¬¸ ì‹œì‘í•˜ê¸°</a>
        `;
        this.messageContainer.appendChild(promptDiv);
        this.scrollToBottom();
    }
    
    showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        this.messageContainer.appendChild(errorDiv);
        this.scrollToBottom();
        
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }
    
    async loadChatHistory() {
        try {
            const response = await fetch('/api/chat-history');
            const data = await response.json();
            
            if (data.success && data.history) {
                data.history.forEach(item => {
                    this.addMessage(item.message, 'user');
                    this.addMessage(item.response, 'ai');
                });
            }
        } catch (error) {
            console.error('ëŒ€í™” ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }
    
    saveChatHistory() {
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì„ì‹œ ì €ì¥
        const messages = Array.from(this.messageContainer.children)
            .filter(el => el.classList.contains('pixie-message'))
            .map(el => ({
                type: el.classList.contains('pixie-message-user') ? 'user' : 'ai',
                content: el.querySelector('.message-content').textContent,
                time: el.querySelector('.message-time')?.textContent
            }));
            
        localStorage.setItem('pixie_chat_history', JSON.stringify(messages));
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    window.chatbotManager = new ChatbotManager();
});
```

---

## 5. ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°

### 5.1 Server-Sent Events (SSE)

#### 5.1.1 ì„œë²„ êµ¬í˜„
```python
def generate():
    """SSE ìŠ¤íŠ¸ë¦¼ ìƒì„±ê¸°"""
    try:
        # ìƒíƒœ ì—…ë°ì´íŠ¸ ì „ì†¡
        yield f"event: status\ndata: {json.dumps({'agent': 'AI-A', 'status': 'thinking'})}\n\n"
        
        # ì—ì´ì „íŠ¸ ì‘ë‹µ ì „ì†¡
        yield f"event: agent\ndata: {json.dumps({'agent': 'AI-A', 'response': ai_a_response})}\n\n"
        
        # ìµœì¢… ì‘ë‹µ ì „ì†¡
        yield f"data: {json.dumps({'content': final_response})}\n\n"
        
        # ì™„ë£Œ ì´ë²¤íŠ¸
        yield "event: complete\ndata: {}\n\n"
        
    except Exception as e:
        yield f"event: error\ndata: {json.dumps({'error': str(e)})}\n\n"
```

#### 5.1.2 í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
```javascript
const eventSource = new EventSource(url);

// ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
eventSource.addEventListener('status', (event) => {
    const data = JSON.parse(event.data);
    updateStatusIndicator(data.agent, data.status);
});

// ì—ì´ì „íŠ¸ ì‘ë‹µ ì²˜ë¦¬
eventSource.addEventListener('agent', (event) => {
    const data = JSON.parse(event.data);
    displayAgentResponse(data.agent, data.response);
});

// ìµœì¢… ì‘ë‹µ ì²˜ë¦¬
eventSource.addEventListener('message', (event) => {
    const data = JSON.parse(event.data);
    displayFinalResponse(data.content);
});

// ì™„ë£Œ ì²˜ë¦¬
eventSource.addEventListener('complete', () => {
    eventSource.close();
    enableUserInput();
});
```

### 5.2 ìƒíƒœ í‘œì‹œ UI

```html
<div class="agent-status-panel">
    <div class="agent-status" id="status-AI-A">
        <span class="status-icon">âšª</span>
        <span class="status-text">AI-A: ëŒ€ê¸° ì¤‘</span>
    </div>
    <div class="agent-status" id="status-AI-A2">
        <span class="status-icon">âšª</span>
        <span class="status-text">AI-A2: ëŒ€ê¸° ì¤‘</span>
    </div>
    <div class="agent-status" id="status-AI-B">
        <span class="status-icon">âšª</span>
        <span class="status-text">AI-B: ëŒ€ê¸° ì¤‘</span>
    </div>
</div>
```

```css
.agent-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-bottom: 8px;
}

.status-icon {
    font-size: 12px;
}

.agent-status.active .status-icon {
    color: #00a884;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
```

---

## 6. ìƒíƒœ ê´€ë¦¬

### 6.1 ì„¸ì…˜ ê´€ë¦¬

```python
# ì„¸ì…˜ ID ìƒì„± ë° ê´€ë¦¬ (app.py:2278-2281)
session_id = session.get('user_id')
if not session_id:
    session_id = f"user_{str(uuid.uuid4())[:8]}"
    session['user_id'] = session_id
```

### 6.2 ë©”ëª¨ë¦¬ ê´€ë¦¬ (`memory_manager.py`)

```python
class MemoryManager:
    """ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ë° ì‚¬ìš©ì í”„ë¡œí•„ ê´€ë¦¬"""
    
    def __init__(self):
        self.conversations = []
        self.user_profile = None
        self.ai_conversations = []  # AI ê°„ ëŒ€í™”
        self.session_data = {}
        
    def save_memory(self, role: str, content: str) -> None:
        """ëŒ€í™” ë©”ëª¨ë¦¬ ì €ì¥"""
        self.conversations.append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })
        
        # ë©”ëª¨ë¦¬ í¬ê¸° ì œí•œ (ìµœê·¼ 20ê°œ)
        if len(self.conversations) > 20:
            self.conversations = self.conversations[-20:]
    
    def get_conversation_context(self, limit: int = 5) -> List[Dict]:
        """ìµœê·¼ ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ë°˜í™˜"""
        return self.conversations[-limit:] if self.conversations else []
    
    def set_user_profile(self, profile: Dict[str, Any]) -> None:
        """ì‚¬ìš©ì í”„ë¡œí•„ ì„¤ì •"""
        self.user_profile = profile
        logger.info(f"User profile set: {profile.get('investor_type', 'Unknown')}")
    
    def clear_ai_conversations(self) -> None:
        """AI ê°„ ëŒ€í™” ì´ˆê¸°í™”"""
        self.ai_conversations = []
```

### 6.3 ëŒ€í™” ê¸°ë¡ ì €ì¥

```python
# Supabaseì— ëŒ€í™” ì €ì¥ (app.py:2394-2400)
if supabase:
    supabase.table("chat_history").insert({
        "user_id": session_id,
        "message": message,
        "response": response,
        "created_at": datetime.now().isoformat()
    }).execute()
```

---

## 7. UI/UX ë””ìì¸

### 7.1 ë°˜ì‘í˜• ë””ìì¸

```css
/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
    .pixie-chatbot-container {
        padding: 0;
    }
    
    .pixie-chat-wrapper {
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    
    .pixie-message {
        max-width: 85%;
    }
    
    .pixie-chat-input {
        font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
    }
}

/* ë‹¤í¬ëª¨ë“œ ì§€ì› */
@media (prefers-color-scheme: dark) {
    .pixie-chat-wrapper {
        background: #1a1a1a;
        border-color: #333;
    }
    
    .pixie-chat-messages {
        background: #0d0d0d;
    }
    
    .pixie-message-ai {
        background: #2a2a2a;
        color: #e0e0e0;
    }
}
```

### 7.2 ì ‘ê·¼ì„± ê°œì„ 

```html
<!-- ARIA ë ˆì´ë¸” -->
<div class="pixie-chat-wrapper" role="main" aria-label="AI ì±—ë´‡ ëŒ€í™”ì°½">
    <div class="pixie-chat-messages" role="log" aria-live="polite" aria-label="ëŒ€í™” ë‚´ìš©">
        <!-- ë©”ì‹œì§€ë“¤ -->
    </div>
    
    <div class="pixie-chat-input-container">
        <input type="text" 
               class="pixie-chat-input" 
               id="chatInput"
               aria-label="ë©”ì‹œì§€ ì…ë ¥"
               placeholder="íˆ¬ìì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...">
        <button class="pixie-chat-send" 
                id="sendButton"
                aria-label="ë©”ì‹œì§€ ì „ì†¡">
            <i class="bi bi-send-fill" aria-hidden="true"></i>
        </button>
    </div>
</div>
```

### 7.3 ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼

```css
/* ë©”ì‹œì§€ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes pixieMessageSlide {
    from { 
        opacity: 0; 
        transform: translateY(10px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

/* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
@keyframes pixieTyping {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* ì—ì´ì „íŠ¸ ì „í™˜ íš¨ê³¼ */
.agent-transition {
    animation: agentSwitch 0.5s ease;
}

@keyframes agentSwitch {
    0% { opacity: 0; transform: translateX(-20px); }
    100% { opacity: 1; transform: translateX(0); }
}
```

---

## 8. ì—ëŸ¬ ì²˜ë¦¬

### 8.1 ë°±ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬

```python
# investment_advisor.py:95-161
def chat(self, user_input: str) -> str:
    """ë©”ì¸ ì±—ë´‡ í•¨ìˆ˜ with comprehensive error handling"""
    try:
        # ì„¸ì…˜ ID í™•ì¸
        if not self.session_id:
            return "ì„¸ì…˜ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
            
        # ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ
        user_profile = self._load_user_profile()
        if not user_profile:
            return "íˆ¬ì ì„±í–¥ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ì„¤ë¬¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”."
            
        # AI ì²´ì¸ ì‹¤í–‰
        try:
            # AI-A ì‹¤í–‰
            ai_a_response = self._execute_ai_a(user_input, user_profile)
        except Exception as e:
            logger.error(f"AI-A ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            return self._get_fallback_response("initial", user_input)
            
        try:
            # AI-A2 ì‹¤í–‰
            ai_a2_response = self._execute_ai_a2(user_input, ai_a_response, user_profile)
        except Exception as e:
            logger.error(f"AI-A2 ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            # AI-A ì‘ë‹µë§Œìœ¼ë¡œ ì§„í–‰
            return self._format_single_agent_response(ai_a_response)
            
        try:
            # AI-B ì‹¤í–‰
            ai_b_response = self._execute_ai_b(ai_a2_response)
        except Exception as e:
            logger.error(f"AI-B ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            # AI-Aì™€ AI-A2 ì‘ë‹µìœ¼ë¡œ ìµœì¢… ì‘ë‹µ ìƒì„±
            return self._generate_response_without_data(ai_a_response, ai_a2_response)
            
        # ìµœì¢… ì‘ë‹µ ìƒì„±
        return self._generate_final_response(user_input, ai_a_response, ai_b_response, user_profile)
        
    except Exception as e:
        logger.error(f"ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
        return "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
```

### 8.2 í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬

```javascript
class ErrorHandler {
    constructor() {
        this.retryCount = 0;
        this.maxRetries = 3;
    }
    
    async handleApiError(error, retryFunc) {
        console.error('API ì˜¤ë¥˜:', error);
        
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
        if (!navigator.onLine) {
            this.showError('ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return null;
        }
        
        // 401: ì¸ì¦ ì˜¤ë¥˜
        if (error.status === 401) {
            this.showError('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return null;
        }
        
        // 429: Rate limiting
        if (error.status === 429) {
            this.showError('ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return null;
        }
        
        // 500: ì„œë²„ ì˜¤ë¥˜ - ì¬ì‹œë„
        if (error.status >= 500 && this.retryCount < this.maxRetries) {
            this.retryCount++;
            await this.delay(1000 * this.retryCount); // ì§€ìˆ˜ ë°±ì˜¤í”„
            return retryFunc();
        }
        
        // ê¸°íƒ€ ì˜¤ë¥˜
        this.showError('ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return null;
    }
    
    showError(message) {
        const errorToast = document.createElement('div');
        errorToast.className = 'error-toast';
        errorToast.innerHTML = `
            <i class="bi bi-exclamation-circle"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
            errorToast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            errorToast.classList.remove('show');
            setTimeout(() => errorToast.remove(), 300);
        }, 5000);
    }
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
```

### 8.3 í´ë°± ë©”ì»¤ë‹ˆì¦˜

```python
# investment_advisor.py
def _get_fallback_response(self, stage: str, user_input: str) -> str:
    """ë‹¨ê³„ë³„ í´ë°± ì‘ë‹µ ìƒì„±"""
    fallback_responses = {
        'initial': """
íˆ¬ìì— ê´€í•œ ì§ˆë¬¸ ê°ì‚¬í•©ë‹ˆë‹¤. í˜„ì¬ ì‹œìŠ¤í…œì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆì–´ 
ìƒì„¸í•œ ë¶„ì„ì„ ì œê³µí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.

ì¼ë°˜ì ì¸ íˆ¬ì ì›ì¹™:
1. ë¶„ì‚° íˆ¬ìë¥¼ í†µí•œ ìœ„í—˜ ê´€ë¦¬
2. ì¥ê¸°ì  ê´€ì ì˜ íˆ¬ì
3. ë³¸ì¸ì˜ ìœ„í—˜ ê°ìˆ˜ ìˆ˜ì¤€ ê³ ë ¤
4. ì •ê¸°ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹±

ë” êµ¬ì²´ì ì¸ ì¡°ì–¸ì´ í•„ìš”í•˜ì‹œë©´ ì ì‹œ í›„ ë‹¤ì‹œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
""",
        'data_unavailable': """
í˜„ì¬ ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
í•˜ì§€ë§Œ ê·€í•˜ì˜ íˆ¬ì ì„±í–¥ì„ ë°”íƒ•ìœ¼ë¡œ ì¼ë°˜ì ì¸ ì¡°ì–¸ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

[íˆ¬ì ì„±í–¥ ê¸°ë°˜ ì¼ë°˜ ì¡°ì–¸ ì œê³µ]
""",
        'partial': """
ì¼ë¶€ ì •ë³´ë§Œ ì´ìš© ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤.
ì œí•œëœ ì •ë³´ë¡œ ìµœì„ ì˜ ì¡°ì–¸ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

[ì´ìš© ê°€ëŠ¥í•œ ì •ë³´ ê¸°ë°˜ ì¡°ì–¸]
"""
    }
    
    return fallback_responses.get(stage, "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
```

---

## 9. ì„±ëŠ¥ ìµœì í™”

### 9.1 ì‘ë‹µ ìºì‹±

```python
from functools import lru_cache
import hashlib

class ResponseCache:
    def __init__(self, max_size=100, ttl=3600):
        self.cache = {}
        self.max_size = max_size
        self.ttl = ttl
        
    def get_cache_key(self, user_input: str, user_profile: dict) -> str:
        """ìºì‹œ í‚¤ ìƒì„±"""
        profile_str = json.dumps(user_profile, sort_keys=True)
        combined = f"{user_input}:{profile_str}"
        return hashlib.md5(combined.encode()).hexdigest()
        
    def get(self, key: str) -> Optional[str]:
        """ìºì‹œì—ì„œ ì‘ë‹µ ì¡°íšŒ"""
        if key in self.cache:
            entry = self.cache[key]
            if time.time() - entry['timestamp'] < self.ttl:
                return entry['response']
            else:
                del self.cache[key]
        return None
        
    def set(self, key: str, response: str) -> None:
        """ìºì‹œì— ì‘ë‹µ ì €ì¥"""
        if len(self.cache) >= self.max_size:
            # LRU ì œê±°
            oldest_key = min(self.cache.keys(), 
                           key=lambda k: self.cache[k]['timestamp'])
            del self.cache[oldest_key]
            
        self.cache[key] = {
            'response': response,
            'timestamp': time.time()
        }
```

### 9.2 ë³‘ë ¬ ì²˜ë¦¬

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class ParallelAdvisor:
    def __init__(self):
        self.executor = ThreadPoolExecutor(max_workers=3)
        
    async def process_parallel_agents(self, user_input, user_profile):
        """AI-Aì™€ ë°ì´í„° ìˆ˜ì§‘ì„ ë³‘ë ¬ ì²˜ë¦¬"""
        loop = asyncio.get_event_loop()
        
        # ë³‘ë ¬ ì‹¤í–‰
        tasks = [
            loop.run_in_executor(self.executor, self._run_ai_a, user_input, user_profile),
            loop.run_in_executor(self.executor, self._collect_market_data, user_input),
            loop.run_in_executor(self.executor, self._analyze_news_sentiment)
        ]
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # ê²°ê³¼ ì²˜ë¦¬
        ai_a_response = results[0] if not isinstance(results[0], Exception) else None
        market_data = results[1] if not isinstance(results[1], Exception) else {}
        news_sentiment = results[2] if not isinstance(results[2], Exception) else {}
        
        return ai_a_response, market_data, news_sentiment
```

### 9.3 ìŠ¤íŠ¸ë¦¬ë° ìµœì í™”

```javascript
class StreamOptimizer {
    constructor() {
        this.buffer = [];
        this.flushInterval = 100; // 100ms
        this.flushTimer = null;
    }
    
    addChunk(chunk) {
        this.buffer.push(chunk);
        
        if (!this.flushTimer) {
            this.flushTimer = setTimeout(() => this.flush(), this.flushInterval);
        }
    }
    
    flush() {
        if (this.buffer.length === 0) return;
        
        // ë²„í¼ ë‚´ìš©ì„ í•œ ë²ˆì— ë Œë”ë§
        const content = this.buffer.join('');
        this.renderContent(content);
        
        this.buffer = [];
        this.flushTimer = null;
    }
    
    renderContent(content) {
        // DOM ì—…ë°ì´íŠ¸ ìµœì†Œí™”
        requestAnimationFrame(() => {
            const messageEl = document.getElementById('currentMessage');
            if (messageEl) {
                messageEl.innerHTML += this.formatContent(content);
            }
        });
    }
}
```

---

## 10. ë³´ì•ˆ ë° í”„ë¼ì´ë²„ì‹œ

### 10.1 ì…ë ¥ ê²€ì¦

```python
import re
from typing import Optional

class InputValidator:
    """ì‚¬ìš©ì ì…ë ¥ ê²€ì¦"""
    
    @staticmethod
    def validate_message(message: str) -> tuple[bool, Optional[str]]:
        """ë©”ì‹œì§€ ìœ íš¨ì„± ê²€ì¦"""
        # ê¸¸ì´ ê²€ì‚¬
        if len(message) > 1000:
            return False, "ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤. (ìµœëŒ€ 1000ì)"
            
        # ì•…ì„± íŒ¨í„´ ê²€ì‚¬
        malicious_patterns = [
            r'<script.*?>.*?</script>',
            r'javascript:',
            r'on\w+\s*=',
            r'eval\s*\(',
            r'exec\s*\('
        ]
        
        for pattern in malicious_patterns:
            if re.search(pattern, message, re.IGNORECASE):
                return False, "í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                
        # SQL ì¸ì ì…˜ ë°©ì§€
        sql_keywords = ['DROP', 'DELETE', 'INSERT', 'UPDATE', 'UNION']
        message_upper = message.upper()
        for keyword in sql_keywords:
            if keyword in message_upper:
                return False, "í—ˆìš©ë˜ì§€ ì•ŠëŠ” í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                
        return True, None
```

### 10.2 ë°ì´í„° ì•”í˜¸í™”

```python
from cryptography.fernet import Fernet
import base64

class DataEncryption:
    """ë¯¼ê°í•œ ë°ì´í„° ì•”í˜¸í™”"""
    
    def __init__(self, key: Optional[str] = None):
        if key:
            self.cipher = Fernet(key.encode())
        else:
            self.cipher = Fernet(Fernet.generate_key())
            
    def encrypt_profile(self, profile: dict) -> str:
        """ì‚¬ìš©ì í”„ë¡œí•„ ì•”í˜¸í™”"""
        profile_json = json.dumps(profile)
        encrypted = self.cipher.encrypt(profile_json.encode())
        return base64.b64encode(encrypted).decode()
        
    def decrypt_profile(self, encrypted_data: str) -> dict:
        """ì‚¬ìš©ì í”„ë¡œí•„ ë³µí˜¸í™”"""
        try:
            decoded = base64.b64decode(encrypted_data.encode())
            decrypted = self.cipher.decrypt(decoded)
            return json.loads(decrypted.decode())
        except Exception as e:
            logger.error(f"ë³µí˜¸í™” ì‹¤íŒ¨: {e}")
            return {}
```

### 10.3 ì„¸ì…˜ ë³´ì•ˆ

```python
# Flask ì„¸ì…˜ ì„¤ì •
app.config.update(
    SECRET_KEY=os.environ.get('FLASK_SECRET_KEY', 'change-this-in-production'),
    SESSION_COOKIE_SECURE=True,  # HTTPS only
    SESSION_COOKIE_HTTPONLY=True,  # JavaScript ì ‘ê·¼ ì°¨ë‹¨
    SESSION_COOKIE_SAMESITE='Lax',  # CSRF ë°©ì§€
    PERMANENT_SESSION_LIFETIME=timedelta(hours=2)  # 2ì‹œê°„ ë§Œë£Œ
)

# ì„¸ì…˜ ê²€ì¦ ë°ì½”ë ˆì´í„°
def require_session(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return jsonify({'error': 'Session required'}), 401
        return f(*args, **kwargs)
    return decorated_function
```

### 10.4 Rate Limiting

```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

# Rate limiter ì„¤ì •
limiter = Limiter(
    app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)

# ì±—ë´‡ APIì— rate limiting ì ìš©
@app.route('/api/chat', methods=['POST'])
@limiter.limit("1 per second")  # ì´ˆë‹¹ 1íšŒ
@limiter.limit("30 per minute")  # ë¶„ë‹¹ 30íšŒ
@limiter.limit("500 per day")    # ì¼ë‹¹ 500íšŒ
def chat():
    # ... ì±—ë´‡ ë¡œì§
```

---

## ë§ˆë¬´ë¦¬

AI ì±—ë´‡ í˜ì´ì§€ëŠ” Pixie ì„œë¹„ìŠ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ìœ¼ë¡œ, ë©€í‹° ì—ì´ì „íŠ¸ AI ì‹œìŠ¤í…œì„ í†µí•´ ê°œì¸í™”ëœ íˆ¬ì ì¡°ì–¸ì„ ì œê³µí•©ë‹ˆë‹¤. ì£¼ìš” íŠ¹ì§•ì€:

1. **ë©€í‹° ì—ì´ì „íŠ¸ ì•„í‚¤í…ì²˜**: AI-A â†’ AI-A2 â†’ AI-B â†’ Final Responseì˜ ì²´ê³„ì ì¸ ì²˜ë¦¬
2. **ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°**: SSEë¥¼ í†µí•œ ë¶€ë“œëŸ¬ìš´ ì‚¬ìš©ì ê²½í—˜
3. **ê°•ë ¥í•œ ì—ëŸ¬ ì²˜ë¦¬**: ê° ë‹¨ê³„ë³„ í´ë°± ë©”ì»¤ë‹ˆì¦˜
4. **ë³´ì•ˆ ë° í”„ë¼ì´ë²„ì‹œ**: ì…ë ¥ ê²€ì¦, ë°ì´í„° ì•”í˜¸í™”, rate limiting
5. **ì„±ëŠ¥ ìµœì í™”**: ìºì‹±, ë³‘ë ¬ ì²˜ë¦¬, ìŠ¤íŠ¸ë¦¬ë° ìµœì í™”

ì´ ë¬¸ì„œëŠ” AI ì±—ë´‡ í˜ì´ì§€ì˜ ì „ì²´ êµ¬í˜„ì„ ìƒì„¸íˆ ë‹¤ë£¨ë©°, í–¥í›„ ìœ ì§€ë³´ìˆ˜ì™€ í™•ì¥ì„ ìœ„í•œ ê¸°ìˆ ì  ì°¸ê³  ìë£Œë¡œ í™œìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.